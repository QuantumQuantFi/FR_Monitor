# 回测规划（watchlist TypeB/TypeC 价差套利）

本文档描述基于现有数据库历史数据的回测规划，用于评估 TypeB/TypeC 条件触发的价差套利策略，并计算特征与未来 8h/24h 净收益（扣手续费、资金费率）的线性回归 IC/IR。

## 阶段与任务

1. 范围与数据盘点  
   - 明确 TypeB/TypeC 信号定义与需要的字段。  
   - 查看 `market_data.db` 表结构/时间戳/品种覆盖，确认是否具备手续费、资金费率或可推导字段，记录缺口。  
   - 统一时区与采样粒度（如 1m/5m），制定缺失值处理方案。

2. 输入与特征设计  
   - 定义价差对象：配对/篮子、对冲比例、名义规模、手续费/资金费率假设。  
   - 构造特征：价差 Z 分数、波动率、成交量/深度、资金费率差、基差、盘口不平衡等。  
   - 标签：未来 8h/24h 价差 PnL/单位，已扣手续费和资金费率。

3. 信号与规则编码  
   - 实现 TypeB/TypeC 入场/出场逻辑、冷静期、持仓上限、止损/止盈。  
   - 约束：缺失数据处理、交易时段、交易所可用性、最大并发持仓。

4. 回测引擎实现  
   - SQLite 数据加载器：批量取数、时区对齐、重采样。  
   - 价差计算与持仓模拟：开仓/平仓、费用/资金费率/滑点建模。  
   - 输出逐 bar/逐笔 PnL 与交易日志，支持参数化运行。

5. 评估与指标  
   - 对特征与 8h/24h 实现 PnL 做线性回归，计算 IC/IR；检查残差与稳健性。  
   - 绩效汇总：命中率、回撤、换手、费用拖累、参数灵敏度。

6. 验证与稳健性  
   - 分时段/交易所/品种交叉验证，必要时进行 walk-forward。  
   - 自检：fee=0 基线对比、资金费率=0 对比，保证逻辑一致性。

7. 报告输出  
   - 生成按品种/时间框/参数集的表格与图表。  
   - 记录数据质量注意事项与后续行动项。

## 建议的目录/脚手架（后续可补充）

- `data_loader.py`：SQLite 读取、重采样、缺失处理。  
- `features.py`：价差与特征工程（Z 分数、波动、成交量/深度、资金费率差等）。  
- `signals.py`：TypeB/TypeC 触发、入场/出场规则。  
- `backtester.py`：持仓模拟、费用/资金费率/滑点、逐 bar PnL。  
- `metrics.py`：回归、IC/IR、绩效统计、参数扫描。  
- `reports.py`：汇总表与图表输出。  
- `notebooks/`（可选）：交互式分析与可视化。

## 后续步骤

- 等待信号细节/字段定义后，补充具体实现与参数。  
- 按目录创建初版脚手架，保证可配置的价差对象与费用模型。  
- 编写最小化示例回测和 IC/IR 计算，验证数据链路通畅。

## 现状评审（基于现有 DB）

- 时间戳：当前 `price_data.timestamp` 范围到 2025-12-07，与你的系统时间一致，暂未发现时钟漂移问题，但后续回测需确认各交易所时间同步是否稳定。  
- 缺失值：`spot_price`/`futures_price`/`funding_rate` 等缺失时写入 0，无法区分“缺数据 vs 真实为 0”，回测时会误判。应改为写入 NULL，并在聚合/特征计算时过滤缺失。  
- 衍生字段缺口：`mark_price`、`index_price`、`premium_percent`、`volume_24h` 多为 0（Binance 基本缺失），限制基差/溢价/流动性特征与 TypeC 边界判断。需在采集层补全。  
- 费用信息：DB 未存储手续费参数，需在回测配置中固定费率（现货千分之一，U 本位合约万分之五）或另建费率表。资金费已有 `funding_rate`/`funding_interval_hours`，但需确保 `next_funding_time` 准确、非 NULL。  
- 跨交易所对齐：每行是单交易所快照，没有跨交易所的同步标记，回测时需在提取阶段用时间窗口对齐，以避免错位价差触发。

## 建议的修复步骤

1) 修改写入逻辑，将缺失价格/资金费/量写 NULL 而非 0；聚合与特征阶段显式处理缺失。  
2) 采集端补充 `mark_price`、`index_price`、`premium_percent`、`volume_24h`（或 L2 深度/成交量）以支持基差与流动性特征。  
3) 在回测配置中固定手续费：现货 0.1%，U 本位合约 0.05%；若后续提供分交易所/分档费率，可迁移到参数表。  
4) 数据提取时做跨交易所时间对齐（如 1-5s 窗口/最近点匹配），避免错位价差。  
5) 定期校验 `next_funding_time` 与 `funding_interval_hours` 的覆盖率，缺失则推断或回填。

## 数据清理记录（2025-12-08）

- 代码层面：`database.py` 写入改为缺失/非正数写 NULL，资金费仅源值缺失才置 NULL，真实 0 保留。  
- `price_data` 表：已批量将 spot/futures/mark/index 价格、成交量为 0 的改为 NULL；`funding_interval_hours=0` 改 NULL；空字符串的 `next_funding_time` 改 NULL；`premium_percent` 在 mark/index 缺失时的 0 改 NULL。  
- `price_data_1min` 表：因数据量大，清理过程中止；仅部分 `spot_price_open` 已改为 NULL，其余字段仍可能为 0。如需继续，建议停写窗口下分批处理（每批 10k/50k，设置 busy_timeout），或改用新建精简 watchlist DB。  
- 备份：已生成 `market_data_before_nullfix.db`（大文件，勿入库/提交）。  
- 运行提醒：清理时已停止 `simple_app`，需手动再启动。
