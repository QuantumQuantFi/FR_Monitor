<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多交易所实时价格监控</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0d1421;
            color: #ffffff;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .title {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .symbol-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .symbol-btn {
            padding: 8px 16px;
            border: 2px solid #3c4043;
            background: #2b2f36;
            color: #ffffff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .symbol-btn:hover {
            border-color: #f0b90b;
            background: #f0b90b;
            color: #000;
        }
        
        .symbol-btn.active {
            border-color: #f0b90b;
            background: #f0b90b;
            color: #000;
            font-weight: 600;
        }
        
        .exchanges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .exchange-card {
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #3c4043;
        }
        
        .exchange-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            text-transform: uppercase;
            color: #f0b90b;
        }
        
        .price-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .price-label {
            color: #8e9297;
            font-size: 14px;
        }
        
        .price-value {
            font-weight: 600;
            font-size: 16px;
        }
        
        .spot-price { color: #00d4aa; }
        .futures-price { color: #f6465d; }
        .funding-rate { color: #ffa500; }
        .premium { color: #c99400; }
        
        .chart-container {
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #3c4043;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #f0b90b;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: #2b2f36;
            border: 1px solid #3c4043;
        }
        
        .connected { border-color: #00d4aa; color: #00d4aa; }
        .disconnected { border-color: #f6465d; color: #f6465d; }
        
        .timestamp {
            text-align: center;
            color: #8e9297;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .loading {
            text-align: center;
            color: #8e9297;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">多交易所实时价格监控</div>
        <div class="symbol-selector">
            <span style="color: #8e9297; margin-right: 10px;">币种:</span>
            {% for symbol in symbols %}
            <button class="symbol-btn {% if symbol == current_symbol %}active{% endif %}" 
                    onclick="switchSymbol('{{ symbol }}')">{{ symbol }}</button>
            {% endfor %}
        </div>
    </div>
    
    <div id="status" class="status disconnected">连接中...</div>
    
    <div class="exchanges-grid" id="exchangesGrid">
        <!-- 交易所卡片将通过JavaScript动态生成 -->
    </div>
    
    <div class="chart-container">
        <div class="chart-title">实时价格走势</div>
        <canvas id="priceChart" width="400" height="200"></canvas>
    </div>
    
    <div class="chart-container">
        <div class="chart-title">资金费率对比</div>
        <canvas id="fundingChart" width="400" height="200"></canvas>
    </div>
    
    <div class="timestamp" id="lastUpdate">等待数据更新...</div>

    <script>
        const socket = io();
        let currentSymbol = '{{ current_symbol }}';
        let priceChart, fundingChart;
        
        // 初始化图表
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: { color: '#ffffff' }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#8e9297' },
                        grid: { color: '#3c4043' }
                    },
                    y: {
                        ticks: { color: '#8e9297' },
                        grid: { color: '#3c4043' }
                    }
                }
            };
            
            // 价格图表
            const priceCtx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'OKX 现货',
                            data: [],
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'OKX 期货',
                            data: [],
                            borderColor: '#f6465d',
                            backgroundColor: 'rgba(246, 70, 93, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Binance 现货',
                            data: [],
                            borderColor: '#ffa500',
                            backgroundColor: 'rgba(255, 165, 0, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Binance 期货',
                            data: [],
                            borderColor: '#c99400',
                            backgroundColor: 'rgba(201, 148, 0, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    height: 200
                }
            });
            
            // 资金费率图表
            const fundingCtx = document.getElementById('fundingChart').getContext('2d');
            fundingChart = new Chart(fundingCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'OKX',
                            data: [],
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Binance',
                            data: [],
                            borderColor: '#ffa500',
                            backgroundColor: 'rgba(255, 165, 0, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Bybit',
                            data: [],
                            borderColor: '#f6465d',
                            backgroundColor: 'rgba(246, 70, 93, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Bitget',
                            data: [],
                            borderColor: '#c99400',
                            backgroundColor: 'rgba(201, 148, 0, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    ...commonOptions,
                    height: 200
                }
            });
        }
        
        // Socket连接事件
        socket.on('connect', function() {
            document.getElementById('status').textContent = '连接成功';
            document.getElementById('status').className = 'status connected';
        });
        
        socket.on('disconnect', function() {
            document.getElementById('status').textContent = '连接断开';
            document.getElementById('status').className = 'status disconnected';
        });
        
        // 市场数据更新
        socket.on('market_update', function(data) {
            updateExchangeCards(data.realtime_data, data.premium_data);
            updateCharts(data.realtime_data);
            document.getElementById('lastUpdate').textContent = 
                `最后更新: ${new Date(data.timestamp).toLocaleTimeString()}`;
        });
        
        // 更新交易所卡片
        function updateExchangeCards(realtimeData, premiumData) {
            const grid = document.getElementById('exchangesGrid');
            grid.innerHTML = '';
            
            for (const [exchange, data] of Object.entries(realtimeData)) {
                const card = document.createElement('div');
                card.className = 'exchange-card';
                
                const spotPrice = data.spot.price || 0;
                const futuresPrice = data.futures.price || 0;
                const fundingRate = data.futures.funding_rate || 0;
                const premium = premiumData[exchange]?.premium_percent || 0;
                
                card.innerHTML = `
                    <div class="exchange-name">${exchange}</div>
                    <div class="price-info">
                        <span class="price-label">现货价格:</span>
                        <span class="price-value spot-price">$${spotPrice.toFixed(4)}</span>
                    </div>
                    <div class="price-info">
                        <span class="price-label">期货价格:</span>
                        <span class="price-value futures-price">$${futuresPrice.toFixed(4)}</span>
                    </div>
                    <div class="price-info">
                        <span class="price-label">资金费率:</span>
                        <span class="price-value funding-rate">${(fundingRate * 100).toFixed(4)}%</span>
                    </div>
                    <div class="price-info">
                        <span class="price-label">溢价指数:</span>
                        <span class="price-value premium">${premium.toFixed(4)}%</span>
                    </div>
                `;
                
                grid.appendChild(card);
            }
        }
        
        // 更新图表
        function updateCharts(realtimeData) {
            const now = new Date().toLocaleTimeString();
            
            // 更新价格图表
            if (priceChart.data.labels.length >= 50) {
                priceChart.data.labels.shift();
                priceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            priceChart.data.labels.push(now);
            priceChart.data.datasets[0].data.push(realtimeData.okx.spot.price || 0);
            priceChart.data.datasets[1].data.push(realtimeData.okx.futures.price || 0);
            priceChart.data.datasets[2].data.push(realtimeData.binance.spot.price || 0);
            priceChart.data.datasets[3].data.push(realtimeData.binance.futures.price || 0);
            priceChart.update('none');
            
            // 更新资金费率图表
            if (fundingChart.data.labels.length >= 50) {
                fundingChart.data.labels.shift();
                fundingChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            
            fundingChart.data.labels.push(now);
            fundingChart.data.datasets[0].data.push(realtimeData.okx.futures.funding_rate || 0);
            fundingChart.data.datasets[1].data.push(realtimeData.binance.futures.funding_rate || 0);
            fundingChart.data.datasets[2].data.push(realtimeData.bybit.futures.funding_rate || 0);
            fundingChart.data.datasets[3].data.push(realtimeData.bitget.futures.funding_rate || 0);
            fundingChart.update('none');
        }
        
        // 切换币种
        function switchSymbol(symbol) {
            socket.emit('switch_symbol', {symbol: symbol});
            currentSymbol = symbol;
            
            // 更新按钮状态
            document.querySelectorAll('.symbol-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === symbol) {
                    btn.classList.add('active');
                }
            });
            
            // 清空图表
            priceChart.data.labels = [];
            priceChart.data.datasets.forEach(dataset => dataset.data = []);
            priceChart.update();
            
            fundingChart.data.labels = [];
            fundingChart.data.datasets.forEach(dataset => dataset.data = []);
            fundingChart.update();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
        });
    </script>
</body>
</html>