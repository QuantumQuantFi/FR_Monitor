<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多交易所币种聚合监控</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #0d1421;
            color: #ffffff;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .title {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            padding: 10px 15px;
            border: 2px solid #3c4043;
            background: #2b2f36;
            color: #ffffff;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #f0b90b;
        }
        
        .control-btn {
            padding: 10px 20px;
            border: 2px solid #3c4043;
            background: #2b2f36;
            color: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            min-width: 80px;
            text-align: center;
        }
        
        .control-btn:hover {
            border-color: #f0b90b;
            background: #f0b90b;
            color: #000;
        }
        
        .control-btn.active {
            border-color: #f0b90b;
            background: #f0b90b;
            color: #000;
            font-weight: 600;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #1e2329;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #3c4043;
            text-align: center;
        }
        
        .stat-label {
            color: #8e9297;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #f0b90b;
            font-size: 20px;
            font-weight: 600;
        }
        
        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .symbol-card {
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid #3c4043;
            position: relative;
        }
        
        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .symbol-name {
            font-size: 24px;
            font-weight: 600;
            color: #f0b90b;
        }
        
        .coverage-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .coverage-high { background: #00d4aa; color: #000; }
        .coverage-medium { background: #ffa500; color: #000; }
        .coverage-low { background: #f6465d; color: #fff; }
        
        .exchanges-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }
        
        .exchange-item {
            background: #2b2f36;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #3c4043;
            position: relative;
        }
        
        .exchange-item.available {
            border-color: #00d4aa;
        }
        
        .exchange-item.partial {
            border-color: #ffa500;
        }
        
        .exchange-item.unavailable {
            border-color: #f6465d;
            opacity: 0.6;
        }
        
        .exchange-name {
            font-weight: 600;
            font-size: 12px;
            color: #ffffff;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 11px;
        }
        
        .price-label {
            color: #8e9297;
        }
        
        .price-value {
            font-weight: 600;
        }
        
        .spot-price { color: #00d4aa; }
        .futures-price { color: #f6465d; }
        .funding-rate { color: #ffa500; }
        .premium { color: #c99400; }
        
        .no-data {
            color: #666;
            font-style: italic;
            font-size: 10px;
        }
        
        .status-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-online { background: #00d4aa; }
        .status-partial { background: #ffa500; }
        .status-offline { background: #f6465d; }
        
        .loading {
            text-align: center;
            color: #8e9297;
            font-style: italic;
            padding: 40px;
        }
        
        .timestamp {
            text-align: center;
            color: #8e9297;
            font-size: 12px;
            margin-top: 20px;
        }
        
        .auto-refresh {
            color: #00d4aa;
            font-size: 12px;
            text-align: center;
            margin: 10px 0;
        }
        
        .filter-tags {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .filter-tag {
            padding: 4px 8px;
            background: #3c4043;
            border-radius: 12px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-tag:hover, .filter-tag.active {
            background: #f0b90b;
            color: #000;
        }
        
        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-btn {
            padding: 6px 12px;
            background: #3c4043;
            border: none;
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 11px;
        }
        
        .sort-btn.active {
            background: #f0b90b;
            color: #000;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title">多交易所币种聚合监控</div>
        <div class="controls">
            <input type="text" class="search-box" placeholder="搜索币种..." id="searchBox" onkeyup="filterSymbols()">
            <button class="control-btn" onclick="refreshData()">刷新数据</button>
            <button class="control-btn" onclick="toggleSettings()">设置</button>
        </div>
    </div>
    
    <!-- 统计信息栏 -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">监控币种</div>
            <div class="stat-value" id="totalSymbols">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">高覆盖币种</div>
            <div class="stat-value" id="highCoverageSymbols">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">活跃连接</div>
            <div class="stat-value" id="activeConnections">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">数据质量</div>
            <div class="stat-value" id="dataQuality">-</div>
        </div>
    </div>
    
    <!-- 过滤和排序控件 -->
    <div style="background: #1e2329; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <div class="filter-tags">
            <span class="filter-tag active" data-filter="all">全部</span>
            <span class="filter-tag" data-filter="high-coverage">高覆盖度</span>
            <span class="filter-tag" data-filter="medium-coverage">中覆盖度</span>
            <span class="filter-tag" data-filter="low-coverage">低覆盖度</span>
            <span class="filter-tag" data-filter="priority">优先币种</span>
        </div>
        
        <div class="sort-controls">
            <span style="color: #8e9297; font-size: 12px;">排序方式:</span>
            <button class="sort-btn active" data-sort="name">名称</button>
            <button class="sort-btn" data-sort="coverage">覆盖度</button>
            <button class="sort-btn" data-sort="volume">交易量</button>
            <button class="sort-btn" data-sort="premium">溢价率</button>
        </div>
    </div>
    
    <div class="auto-refresh">自动刷新每 0.5 秒 | 数据节流 100ms</div>
    
    <!-- 币种网格 -->
    <div class="symbols-grid" id="symbolsGrid">
        <div class="loading">正在加载币种数据...</div>
    </div>
    
    <div class="timestamp" id="lastUpdate">等待数据更新...</div>

    <script>
        let allSymbolsData = {};
        let filteredSymbols = [];
        let currentFilter = 'all';
        let currentSort = 'name';
        let prioritySymbols = ['WLFI', 'BTC', 'ETH', 'BNB', 'XRP', 'ADA', 'SOL'];
        
        // 格式化资金费率显示
        function formatFundingRate(rate) {
            if (!rate || rate === 0) return '0.0000';
            const percentage = rate * 100;
            if (Math.abs(percentage) < 0.001) {
                return percentage.toFixed(6);
            } else if (Math.abs(percentage) < 0.01) {
                return percentage.toFixed(5);
            } else if (Math.abs(percentage) < 0.1) {
                return percentage.toFixed(4);
            } else {
                return percentage.toFixed(3);
            }
        }
        
        // 计算币种覆盖度
        function calculateCoverage(symbolData) {
            let spotCount = 0;
            let futuresCount = 0;
            const exchanges = ['okx', 'binance', 'bybit', 'bitget'];
            
            exchanges.forEach(exchange => {
                if (symbolData[exchange]?.spot?.price > 0) spotCount++;
                if (symbolData[exchange]?.futures?.price > 0) futuresCount++;
            });
            
            const totalPossible = exchanges.length * 2; // 4个交易所 * 2种市场
            const coverage = (spotCount + futuresCount) / totalPossible * 100;
            
            return {
                coverage: coverage,
                spotCount: spotCount,
                futuresCount: futuresCount,
                level: coverage >= 75 ? 'high' : coverage >= 25 ? 'medium' : 'low'
            };
        }
        
        // 获取币种的最佳价格（用于显示主要价格）
        function getBestPrices(symbolData) {
            let spotPrices = [];
            let futuresPrices = [];
            
            ['okx', 'binance', 'bybit', 'bitget'].forEach(exchange => {
                if (symbolData[exchange]?.spot?.price > 0) {
                    spotPrices.push(symbolData[exchange].spot.price);
                }
                if (symbolData[exchange]?.futures?.price > 0) {
                    futuresPrices.push(symbolData[exchange].futures.price);
                }
            });
            
            return {
                spotAvg: spotPrices.length > 0 ? spotPrices.reduce((a, b) => a + b, 0) / spotPrices.length : 0,
                futuresAvg: futuresPrices.length > 0 ? futuresPrices.reduce((a, b) => a + b, 0) / futuresPrices.length : 0,
                spotRange: spotPrices.length > 0 ? Math.max(...spotPrices) - Math.min(...spotPrices) : 0,
                futuresRange: futuresPrices.length > 0 ? Math.max(...futuresPrices) - Math.min(...futuresPrices) : 0
            };
        }
        
        // 创建单个币种卡片
        function createSymbolCard(symbol, data) {
            const coverage = calculateCoverage(data);
            const prices = getBestPrices(data);
            
            let card = document.createElement('div');
            card.className = 'symbol-card';
            card.dataset.symbol = symbol;
            card.dataset.coverage = coverage.level;
            
            // 检查是否为优先币种
            const isPriority = prioritySymbols.includes(symbol);
            
            card.innerHTML = `
                <div class="symbol-header">
                    <div class="symbol-name">
                        ${symbol}
                        ${isPriority ? '<span style="color: #f0b90b; font-size: 12px;">⭐</span>' : ''}
                    </div>
                    <div class="coverage-badge coverage-${coverage.level}">
                        ${coverage.coverage.toFixed(0)}% 覆盖
                    </div>
                </div>
                
                ${prices.spotAvg > 0 || prices.futuresAvg > 0 ? `
                <div style="margin-bottom: 15px; padding: 10px; background: #2b2f36; border-radius: 6px;">
                    ${prices.spotAvg > 0 ? `<div style="font-size: 14px; color: #00d4aa;">现货均价: $${prices.spotAvg.toFixed(4)}</div>` : ''}
                    ${prices.futuresAvg > 0 ? `<div style="font-size: 14px; color: #f6465d;">期货均价: $${prices.futuresAvg.toFixed(4)}</div>` : ''}
                </div>
                ` : ''}
                
                <div class="exchanges-list">
                    ${createExchangesList(symbol, data)}
                </div>
            `;
            
            return card;
        }
        
        // 创建交易所列表
        function createExchangesList(symbol, data) {
            const exchanges = ['okx', 'binance', 'bybit', 'bitget'];
            return exchanges.map(exchange => {
                const exchangeData = data[exchange] || {};
                const hasSpot = exchangeData.spot?.price > 0;
                const hasFutures = exchangeData.futures?.price > 0;
                
                let status = 'unavailable';
                if (hasSpot && hasFutures) status = 'available';
                else if (hasSpot || hasFutures) status = 'partial';
                
                return `
                    <div class="exchange-item ${status}">
                        <div class="status-indicator status-${status === 'available' ? 'online' : status === 'partial' ? 'partial' : 'offline'}"></div>
                        <div class="exchange-name">${exchange}</div>
                        
                        ${hasSpot ? `
                        <div class="price-row">
                            <span class="price-label">现货</span>
                            <span class="price-value spot-price">$${exchangeData.spot.price.toFixed(4)}</span>
                        </div>
                        ` : '<div class="price-row"><span class="no-data">现货未上市</span></div>'}
                        
                        ${hasFutures ? `
                        <div class="price-row">
                            <span class="price-label">期货</span>
                            <span class="price-value futures-price">$${exchangeData.futures.price.toFixed(4)}</span>
                        </div>
                        <div class="price-row">
                            <span class="price-label">资金费率</span>
                            <span class="price-value funding-rate">${formatFundingRate(exchangeData.futures.funding_rate)}%</span>
                        </div>
                        ` : '<div class="price-row"><span class="no-data">期货未上市</span></div>'}
                    </div>
                `;
            }).join('');
        }
        
        // 过滤币种
        function filterSymbols() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            const grid = document.getElementById('symbolsGrid');
            const cards = grid.querySelectorAll('.symbol-card');
            
            let visibleCount = 0;
            cards.forEach(card => {
                const symbol = card.dataset.symbol.toLowerCase();
                const coverage = card.dataset.coverage;
                
                let matchesSearch = symbol.includes(searchTerm);
                let matchesFilter = currentFilter === 'all' || 
                                 (currentFilter === 'high-coverage' && coverage === 'high') ||
                                 (currentFilter === 'medium-coverage' && coverage === 'medium') ||
                                 (currentFilter === 'low-coverage' && coverage === 'low') ||
                                 (currentFilter === 'priority' && prioritySymbols.includes(card.dataset.symbol));
                
                if (matchesSearch && matchesFilter) {
                    card.style.display = 'block';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            // 更新统计
            document.getElementById('totalSymbols').textContent = visibleCount;
        }
        
        // 更新统计信息
        function updateStats(data) {
            let totalSymbols = 0;
            let highCoverageCount = 0;
            let activeConnections = 0;
            
            Object.keys(data).forEach(symbol => {
                if (data[symbol]) {
                    totalSymbols++;
                    const coverage = calculateCoverage(data[symbol]);
                    if (coverage.level === 'high') highCoverageCount++;
                }
            });
            
            // 简单的连接状态检查
            ['okx', 'binance', 'bybit', 'bitget'].forEach(exchange => {
                let hasData = false;
                Object.keys(data).forEach(symbol => {
                    if (data[symbol][exchange]?.spot?.price > 0 || data[symbol][exchange]?.futures?.price > 0) {
                        hasData = true;
                    }
                });
                if (hasData) activeConnections++;
            });
            
            const dataQuality = Math.round((activeConnections / 4) * 100);
            
            document.getElementById('totalSymbols').textContent = totalSymbols;
            document.getElementById('highCoverageSymbols').textContent = highCoverageCount;
            document.getElementById('activeConnections').textContent = `${activeConnections}/4`;
            document.getElementById('dataQuality').textContent = `${dataQuality}%`;
        }
        
        // 更新币种网格
        function updateSymbolsGrid(data) {
            allSymbolsData = data;
            const grid = document.getElementById('symbolsGrid');
            grid.innerHTML = '';
            
            // 按当前排序方式排序币种
            let symbols = Object.keys(data);
            symbols.sort((a, b) => {
                switch(currentSort) {
                    case 'coverage':
                        const coverageA = calculateCoverage(data[a]);
                        const coverageB = calculateCoverage(data[b]);
                        return coverageB.coverage - coverageA.coverage;
                    case 'name':
                    default:
                        return a.localeCompare(b);
                }
            });
            
            // 创建币种卡片
            symbols.forEach(symbol => {
                if (data[symbol]) {
                    const card = createSymbolCard(symbol, data[symbol]);
                    grid.appendChild(card);
                }
            });
            
            // 应用过滤
            filterSymbols();
            
            // 更新统计
            updateStats(data);
        }
        
        // 获取聚合数据
        async function fetchAggregatedData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                // 重组数据结构：从 交易所->币种 改为 币种->交易所
                const aggregatedData = {};
                
                Object.keys(data.realtime_data).forEach(exchange => {
                    Object.keys(data.realtime_data[exchange]).forEach(symbol => {
                        if (!aggregatedData[symbol]) {
                            aggregatedData[symbol] = {};
                        }
                        aggregatedData[symbol][exchange] = data.realtime_data[exchange][symbol];
                    });
                });
                
                updateSymbolsGrid(aggregatedData);
                document.getElementById('lastUpdate').textContent = 
                    `最后更新: ${new Date(data.timestamp).toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('数据获取错误:', error);
                document.getElementById('symbolsGrid').innerHTML = 
                    '<div class="loading" style="color: #f6465d;">数据加载失败，请检查连接</div>';
            }
        }
        
        // 手动刷新
        function refreshData() {
            fetchAggregatedData();
        }
        
        // 设置面板
        function toggleSettings() {
            alert('设置功能开发中...');
        }
        
        // 初始化事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            // 过滤标签点击事件
            document.querySelectorAll('.filter-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    filterSymbols();
                });
            });
            
            // 排序按钮点击事件
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentSort = this.dataset.sort;
                    if (Object.keys(allSymbolsData).length > 0) {
                        updateSymbolsGrid(allSymbolsData);
                    }
                });
            });
            
            // 初始加载数据
            fetchAggregatedData();
            
            // 开始自动刷新
            setInterval(fetchAggregatedData, 500); // 500ms 刷新间隔
        });
        
        // 页面可见性变化时暂停/恢复刷新
        let refreshInterval;
        function startAutoRefresh() {
            refreshInterval = setInterval(fetchAggregatedData, 500);
        }
        
        window.addEventListener('blur', () => clearInterval(refreshInterval));
        window.addEventListener('focus', startAutoRefresh);
    </script>
</body>
</html>