<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäº¤æ˜“æ‰€å¸ç§èšåˆç›‘æ§ - å¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #0d1421 0%, #1a202c 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #f0b90b 0%, #f8d12f 50%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-box {
            padding: 12px 16px;
            border: 2px solid #3c4043;
            background: rgba(43, 47, 54, 0.8);
            color: #ffffff;
            border-radius: 8px;
            font-size: 14px;
            min-width: 250px;
            transition: all 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #f0b90b;
            background: rgba(43, 47, 54, 1);
        }
        
        .control-btn {
            padding: 12px 20px;
            border: 2px solid #3c4043;
            background: rgba(43, 47, 54, 0.8);
            color: #ffffff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
            min-width: 90px;
            text-align: center;
        }
        
        .control-btn:hover {
            border-color: #f0b90b;
            background: rgba(240, 185, 11, 0.1);
            transform: translateY(-1px);
        }
        
        .control-btn.active {
            border-color: #f0b90b;
            background: #f0b90b;
            color: #000;
            font-weight: 600;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .rest-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        .rest-pill {
            background: rgba(30, 35, 41, 0.8);
            border: 1px solid #3c4043;
            border-radius: 999px;
            padding: 8px 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: #9ca3af;
        }
        .rest-pill .ex {
            color: #f0b90b;
            font-weight: 600;
            text-transform: uppercase;
        }
        .rest-pill .ts { opacity: 0.9; }
        
        .stat-card {
            background: rgba(30, 35, 41, 0.8);
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #3c4043;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #f0b90b;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8c8c8c;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #f0b90b;
        }

        .filter-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 8px 16px;
            border: 1px solid #3c4043;
            background: rgba(43, 47, 54, 0.6);
            color: #ffffff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
            font-weight: 500;
        }
        
        .filter-tab:hover, .filter-tab.active {
            border-color: #f0b90b;
            background: rgba(240, 185, 11, 0.1);
            color: #f0b90b;
        }

        .symbols-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .symbol-card {
            background: linear-gradient(135deg, #1e2329 0%, #2b2f36 100%);
            border: 1px solid #3c4043;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .symbol-card:hover {
            border-color: #f0b90b;
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(240, 185, 11, 0.2);
        }
        
        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #3c4043;
        }
        
        .symbol-name {
            font-size: 18px;
            font-weight: 700;
            color: #f0b90b;
        }
        
        .exchange-count {
            font-size: 11px;
            color: #8c8c8c;
            background: rgba(60, 64, 67, 0.5);
            padding: 4px 8px;
            border-radius: 10px;
        }
        
        .exchanges-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .exchange-box {
            background: rgba(43, 47, 54, 0.6);
            border: 1px solid #3c4043;
            border-radius: 8px;
            padding: 12px;
            transition: all 0.3s ease;
        }
        
        .exchange-box:hover {
            border-color: #f0b90b;
            background: rgba(43, 47, 54, 0.8);
        }
        
        .exchange-name {
            font-size: 12px;
            font-weight: 600;
            color: #f0b90b;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .price-info {
            margin-bottom: 8px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }
        
        .price-label {
            font-size: 10px;
            color: #8c8c8c;
        }
        
        .price-value {
            font-size: 12px;
            font-weight: 600;
            color: #ffffff;
        }
        
        .funding-rate {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .funding-rate.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .funding-rate.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .funding-rate.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
            color: #8c8c8c;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #8c8c8c;
            font-size: 14px;
        }

        .footer-info {
            text-align: center;
            margin: 20px;
            padding: 15px;
            color: #8c8c8c;
            font-size: 12px;
            background: rgba(30, 35, 41, 0.5);
            border-radius: 8px;
        }

        /* ä»·å·®æ¨ªå¹…åŸºç¡€æ ·å¼ */
        .price-diff-banner {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            margin-bottom: 10px;
        }
        .price-diff-banner .diff-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .price-diff-banner .diff-percent {
            font-size: 18px; /* å­—ä½“æ›´å¤§æ›´æ˜æ˜¾ */
            font-weight: 800;
            line-height: 1;
        }
        .price-diff-banner .diff-label {
            font-size: 11px;
            opacity: 0.85;
        }
        .price-diff-banner .diff-right {
            text-align: right;
            line-height: 1.2;
        }
        .price-diff-banner .diff-meta {
            font-size: 11px; /* æ¯”ä¹‹å‰æ›´å¤§ */
            font-weight: 600;
        }
        .price-diff-banner .diff-meta .high { margin-bottom: 2px; }

        /* å››ç§ä¸åŒç»„åˆæ ·å¼ */
        /* â‘  é«˜=ç°è´§, ä½=ç°è´§ */
        .price-diff-style-1 {
            background: rgba(34, 197, 94, 0.12);
            border-color: rgba(34, 197, 94, 0.35);
        }
        .price-diff-style-1 .diff-percent { color: #22c55e; }
        .price-diff-style-1 .diff-label { color: #16a34a; }
        .price-diff-style-1 .diff-right { color: #86efac; }

        /* â‘¡ é«˜=ç°è´§, ä½=æœŸè´§ */
        .price-diff-style-2 {
            background: rgba(59, 130, 246, 0.12);
            border-color: rgba(59, 130, 246, 0.35);
        }
        .price-diff-style-2 .diff-percent { color: #3b82f6; }
        .price-diff-style-2 .diff-label { color: #60a5fa; }
        .price-diff-style-2 .diff-right { color: #bfdbfe; }

        /* â‘¢ é«˜=æœŸè´§, ä½=ç°è´§ */
        .price-diff-style-3 {
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.35);
        }
        .price-diff-style-3 .diff-percent { color: #f59e0b; }
        .price-diff-style-3 .diff-label { color: #fbbf24; }
        .price-diff-style-3 .diff-right { color: #fde68a; }

        /* â‘£ é«˜=æœŸè´§, ä½=æœŸè´§ */
        .price-diff-style-4 {
            background: rgba(244, 63, 94, 0.12);
            border-color: rgba(244, 63, 94, 0.35);
        }
        .price-diff-style-4 .diff-percent { color: #f43f5e; }
        .price-diff-style-4 .diff-label { color: #fb7185; }
        .price-diff-style-4 .diff-right { color: #fecdd3; }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls {
                justify-content: center;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .symbols-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .exchanges-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <h1 class="title">ğŸš€ å¤šäº¤æ˜“æ‰€å®æ—¶ç›‘æ§</h1>
            <div class="controls">
                <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢å¸ç§ (å¦‚: BTC, ETH, WLFI...)">
                <button class="control-btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°</button>
                <button class="control-btn" onclick="toggleAutoRefresh()">â¸ï¸ æš‚åœ</button>
                <button class="control-btn" onclick="togglePriceDiffSort()" id="priceDiffBtn">ğŸ“Š ä»·å·®æ’åº</button>
                <button class="control-btn" onclick="window.open('/exchanges', '_blank')">ğŸ“Š äº¤æ˜“æ‰€è§†å›¾</button>
                <button class="control-btn" onclick="toggleAutoResort()" id="autoResortBtn">æ’åº: å¼€</button>
            </div>
        </div>
        
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-label">æ€»å¸ç§æ•°</div>
                <div class="stat-value" id="totalSymbols">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æ´»è·ƒäº¤æ˜“æ‰€</div>
                <div class="stat-value" id="activeExchanges">4</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ‰æ•°æ®å¸ç§</div>
                <div class="stat-value" id="dataSymbols">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">æœ€åæ›´æ–°</div>
                <div class="stat-value" id="lastUpdate">-</div>
            </div>
        </div>
        
        <div class="filter-tabs">
            <div class="filter-tab active" data-filter="all">å…¨éƒ¨</div>
            <div class="filter-tab" data-filter="hasData">æœ‰æ•°æ®</div>
            <div class="filter-tab" data-filter="multiExchange">å¤šäº¤æ˜“æ‰€</div>
            <div class="filter-tab" data-filter="hasFunding">æœ‰èµ„é‡‘è´¹ç‡</div>
            <div class="filter-tab" data-filter="priceDiff">ä»·å·®æ’åº</div>
            <div class="filter-tab" data-filter="wlfi">WLFI</div>
            <div class="filter-tab" data-filter="mainstream">ä¸»æµå¸</div>
        </div>

        <div class="rest-status" id="restStatusBar">
            <div class="rest-pill"><span class="ex">binance</span><span class="ts" id="rest-binance">-</span></div>
            <div class="rest-pill"><span class="ex">okx</span><span class="ts" id="rest-okx">-</span></div>
            <div class="rest-pill"><span class="ex">bybit</span><span class="ts" id="rest-bybit">-</span></div>
            <div class="rest-pill"><span class="ex">bitget</span><span class="ts" id="rest-bitget">-</span></div>
        </div>
    </div>

    <div class="symbols-grid" id="symbolsGrid">
        <div class="loading">ğŸ”„ åŠ è½½ä¸­...</div>
    </div>

    <div class="footer-info">
        ğŸ’¡ æ”¯æŒæœç´¢å¸ç§åç§° | ğŸ”„ æ¯ç§’è‡ªåŠ¨åˆ·æ–° | ğŸ“Š å®æ—¶ä»·æ ¼å’Œèµ„é‡‘è´¹ç‡ç›‘æ§<br>
        æ”¯æŒçš„äº¤æ˜“æ‰€: Binanceã€OKXã€Bybitã€Bitget
    </div>

    <script>
        let allData = {};
        let filteredData = {};
        let currentFilter = 'all';
        let currentSearch = '';
        let isAutoRefresh = true;
        let refreshInterval;
        let isPriceDiffSortActive = false;
        let autoResort = true;           // æ˜¯å¦è‡ªåŠ¨é‡æ–°æ’åº
        let cardOrder = [];              // å½“å‰å¡ç‰‡é¡ºåºï¼ˆå†»ç»“æ—¶ä½¿ç”¨ï¼‰
        let forceResort = false;         // ç”¨æˆ·æ“ä½œè§¦å‘çš„ä¸€æ¬¡æ€§é‡æ’

        // ä¸»æµå¸ç§åˆ—è¡¨
        const mainstreamSymbols = ['BTC', 'ETH', 'BNB', 'XRP', 'ADA', 'DOGE', 'SOL', 'DOT', 'MATIC', 'AVAX', 'LTC', 'LINK', 'UNI', 'ATOM'];

        // æ ¼å¼åŒ–ä»·æ ¼ - é¿å…ç§‘å­¦è®¡æ•°æ³•ï¼Œä¿æŒåŸå§‹ç²¾åº¦
        function formatPrice(price) {
            if (!price) return '-';
            // ç›´æ¥ä½¿ç”¨åŸå§‹ä»·æ ¼å­—ç¬¦ä¸²ï¼Œé¿å…parseFloaté€ æˆçš„ç²¾åº¦æŸå¤±
            const str = String(price);
            const num = parseFloat(str);
            
            // é¿å…ç§‘å­¦è®¡æ•°æ³•ï¼Œä¿æŒåŸå§‹ç²¾åº¦
            if (num >= 1000) {
                // å¤§äº1000çš„ä»·æ ¼ï¼Œä¿ç•™2ä½å°æ•°
                return num.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            } else if (num >= 1) {
                // 1-1000ä¹‹é—´ï¼Œæœ€å¤šæ˜¾ç¤º8ä½å°æ•°ï¼Œä½†ç§»é™¤æœ«å°¾0
                return parseFloat(num.toFixed(8)).toString();
            } else if (num >= 0.001) {
                // 0.001-1ä¹‹é—´ï¼Œæœ€å¤šæ˜¾ç¤º8ä½å°æ•°ï¼Œä½†ç§»é™¤æœ«å°¾0
                return parseFloat(num.toFixed(8)).toString();
            } else if (num > 0) {
                // å°äº0.001çš„æ­£æ•°ï¼Œä¿ç•™è¶³å¤Ÿç²¾åº¦é¿å…ç§‘å­¦è®¡æ•°æ³•
                const fixed = num.toFixed(12);
                return parseFloat(fixed).toString();
            } else {
                return num.toString();
            }
        }

        // æ ¼å¼åŒ–èµ„é‡‘è´¹ç‡ - ä¿æŒåŸå§‹ç²¾åº¦ï¼Œé¿å…ç§‘å­¦è®¡æ•°æ³•
        function formatFundingRate(rate) {
            if (!rate || rate === 0 || rate === '0') return '-';
            
            // å¤„ç†å­—ç¬¦ä¸²æˆ–æ•°å­—ç±»å‹çš„èµ„é‡‘è´¹ç‡
            let num;
            if (typeof rate === 'string') {
                // å¦‚æœåç«¯ä¼ æ¥é«˜ç²¾åº¦å­—ç¬¦ä¸²ï¼Œç›´æ¥ä½¿ç”¨
                num = parseFloat(rate);
            } else {
                num = rate;
            }
            
            if (num === 0) return '-';
            
            const percentage = num * 100;
            
            // æ ¹æ®æ•°å€¼å¤§å°é€‰æ‹©åˆé€‚çš„å°æ•°ä½æ•°ï¼Œé¿å…ç§‘å­¦è®¡æ•°æ³•
            if (Math.abs(percentage) >= 1) {
                // å¤§äº1%ï¼Œä¿ç•™4ä½å°æ•°
                return `${percentage.toFixed(4)}%`;
            } else if (Math.abs(percentage) >= 0.01) {
                // 0.01%-1%ï¼Œä¿ç•™6ä½å°æ•°
                return `${percentage.toFixed(6)}%`;
            } else if (Math.abs(percentage) >= 0.0001) {
                // 0.0001%-0.01%ï¼Œä¿ç•™8ä½å°æ•°
                return `${percentage.toFixed(8)}%`;
            } else {
                // éå¸¸å°çš„å€¼ï¼Œä¿ç•™10ä½å°æ•°é¿å…ç§‘å­¦è®¡æ•°æ³•
                return `${percentage.toFixed(10)}%`;
            }
        }

        // è·å–èµ„é‡‘è´¹ç‡æ ·å¼ç±»
        function getFundingRateClass(rate) {
            if (!rate || rate === 0) return 'neutral';
            return parseFloat(rate) > 0 ? 'positive' : 'negative';
        }

        // ç»Ÿä¸€è§£æåç«¯æ—¶é—´æˆ³
        function parseTimestamp(ts) {
            if (!ts && ts !== 0) return null;
            if (typeof ts === 'number') {
                return ts < 1e12 ? new Date(ts * 1000) : new Date(ts);
            }
            if (typeof ts === 'string') {
                if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/.test(ts)) {
                    return new Date(ts.replace(' ', 'T') + 'Z');
                }
                const hasOffset = /[zZ]|[\+\-]\d{2}:?\d{2}$/.test(ts);
                if (!hasOffset && /^\d{4}-\d{2}-\d{2}T/.test(ts)) {
                    const normalized = ts.replace(/(\.\d{3})\d+/, '$1') + 'Z';
                    return new Date(normalized);
                }
                return new Date(ts);
            }
            return null;
        }

        // æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºå¯è¯»æ ¼å¼
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            try {
                // å°†æ— æ—¶åŒºæ—¶é—´æˆ³æŒ‰UTCè§£æï¼Œé¿å…ä¸æœ¬åœ°æ—¶åŒºäº§ç”Ÿ8å°æ—¶åå·®
                const date = parseTimestamp(timestamp);
                const now = new Date();
                
                // è®¡ç®—æ—¶é—´å·®
                const diff = now.getTime() - date.getTime();
                
                if (diff < 60000) { // å°äº1åˆ†é’Ÿ
                    return `${Math.floor(diff / 1000)}ç§’å‰`;
                } else if (diff < 3600000) { // å°äº1å°æ—¶
                    return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
                } else if (diff < 86400000) { // å°äº1å¤©
                    return `${Math.floor(diff / 3600000)}å°æ—¶å‰`;
                } else {
                    // è¶…è¿‡1å¤©ï¼Œæ˜¾ç¤ºå…·ä½“æ—¶é—´ï¼ˆæœ¬åœ°æ—¶åŒºï¼‰
                    return date.toLocaleString('zh-CN', {
                        timeZone: 'Asia/Shanghai',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                return '-';
            }
        }

        // è®¡ç®—ä¸¤ä¸ªæ—¶é—´æˆ³çš„å·®å€¼
        function calculateTimeDifference(time1, time2) {
            if (!time1 || !time2) return '-';
            try {
                const date1 = parseTimestamp(time1);
                const date2 = parseTimestamp(time2);
                const diff = Math.abs(date1 - date2);
                
                if (diff < 60000) {
                    return `${Math.floor(diff / 1000)}ç§’`;
                } else if (diff < 3600000) {
                    return `${Math.floor(diff / 60000)}åˆ†é’Ÿ`;
                } else {
                    return `${Math.floor(diff / 3600000)}å°æ—¶`;
                }
            } catch (e) {
                return '-';
            }
        }

        // è®¡ç®—ä»·å·®ç™¾åˆ†æ¯”
        function calculatePriceDifference(symbolData) {
            const prices = [];
            const exchanges = ['binance', 'okx', 'bybit', 'bitget'];
            
            // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆä»·æ ¼ï¼ˆç°è´§å’ŒæœŸè´§ï¼‰
            exchanges.forEach(exchange => {
                if (symbolData[exchange]) {
                    const exData = symbolData[exchange];
                    if (exData.spot && exData.spot.price && exData.spot.price > 0) {
                        prices.push({
                            exchange: exchange,
                            type: 'spot',
                            price: Number(exData.spot.price),  // ä½¿ç”¨Numberè€Œä¸æ˜¯parseFloatä¿æŒç²¾åº¦
                            timestamp: exData.spot.timestamp
                        });
                    }
                    if (exData.futures && exData.futures.price && exData.futures.price > 0) {
                        prices.push({
                            exchange: exchange,
                            type: 'futures',
                            price: Number(exData.futures.price),  // ä½¿ç”¨Numberè€Œä¸æ˜¯parseFloatä¿æŒç²¾åº¦
                            timestamp: exData.futures.timestamp
                        });
                    }
                }
            });
            
            if (prices.length < 2) return null;
            
            // æ‰¾åˆ°æœ€é«˜ä»·å’Œæœ€ä½ä»·
            let maxPrice = Math.max(...prices.map(p => p.price));
            let minPrice = Math.min(...prices.map(p => p.price));
            let maxPriceInfo = prices.find(p => p.price === maxPrice);
            let minPriceInfo = prices.find(p => p.price === minPrice);
            
            // è®¡ç®—ä»·å·®ç™¾åˆ†æ¯”
            let diffPercent = ((maxPrice - minPrice) / minPrice) * 100;
            
            return {
                maxPrice: maxPrice,
                minPrice: minPrice,
                maxExchange: maxPriceInfo.exchange + '(' + maxPriceInfo.type + ')',
                minExchange: minPriceInfo.exchange + '(' + minPriceInfo.type + ')',
                maxType: maxPriceInfo.type,
                minType: minPriceInfo.type,
                maxTimestamp: maxPriceInfo.timestamp,
                minTimestamp: minPriceInfo.timestamp,
                diffPercent: diffPercent,
                diffAmount: maxPrice - minPrice
            };
        }

        // åˆ‡æ¢ä»·å·®æ’åºæ¨¡å¼
        function togglePriceDiffSort() {
            isPriceDiffSortActive = !isPriceDiffSortActive;
            const btn = document.getElementById('priceDiffBtn');
            
            if (isPriceDiffSortActive) {
                btn.textContent = 'ğŸ”¢ æ™®é€šæ’åº';
                btn.classList.add('active');
                currentFilter = 'priceDiff';
                // æ¿€æ´»ä»·å·®æ’åºè¿‡æ»¤æ ‡ç­¾
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-filter="priceDiff"]').classList.add('active');
                // ç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢æ’åºæ¨¡å¼ï¼šè§¦å‘ä¸€æ¬¡æ€§é‡æ’
                forceResort = true;
            } else {
                btn.textContent = 'ğŸ“Š ä»·å·®æ’åº';
                btn.classList.remove('active');
                currentFilter = 'all';
                // å›åˆ°å…¨éƒ¨æ ‡ç­¾
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-filter="all"]').classList.add('active');
                // ç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢æ’åºæ¨¡å¼ï¼šè§¦å‘ä¸€æ¬¡æ€§é‡æ’
                forceResort = true;
            }
            
            applyFilters();
        }

        // åˆ‡æ¢è‡ªåŠ¨é‡æ–°æ’åºï¼ˆå…³ï¼šä¸æ”¹å˜å¡ç‰‡é¡ºåºï¼Œä»…æ›´æ–°å†…å®¹ï¼‰
        function toggleAutoResort() {
            autoResort = !autoResort;
            const btn = document.getElementById('autoResortBtn');
            btn.textContent = `æ’åº: ${autoResort ? 'å¼€' : 'å…³'}`;
            if (autoResort) {
                // å¼€å¯åç«‹å³æŒ‰å½“å‰æ¨¡å¼é‡æ’ä¸€æ¬¡
                forceResort = true;
                applyFilters();
            }
        }

        // æ›´æ–°å¸ç§ç½‘æ ¼
        function updateSymbolsGrid(data) {
            const grid = document.getElementById('symbolsGrid');
            let symbols = Object.keys(data);

            const computeSorted = () => {
                if (isPriceDiffSortActive) {
                    const symbolsWithDiff = symbols.map(symbol => {
                        const diff = calculatePriceDifference(data[symbol]);
                        return { symbol, priceDiff: diff };
                    }).filter(item => item.priceDiff !== null)
                      .sort((a, b) => b.priceDiff.diffPercent - a.priceDiff.diffPercent);
                    return symbolsWithDiff.map(item => item.symbol);
                } else {
                    return symbols.slice().sort();
                }
            };

            if (autoResort || cardOrder.length === 0 || forceResort) {
                symbols = computeSorted();
                cardOrder = symbols.slice();
                forceResort = false;
            } else {
                const ordered = cardOrder.filter(s => symbols.includes(s));
                const remaining = symbols.filter(s => !ordered.includes(s)).sort();
                symbols = ordered.concat(remaining);
                cardOrder = symbols.slice();
            }
            
            if (symbols.length === 0) {
                grid.innerHTML = '<div class="no-data">æš‚æ— æ•°æ®</div>';
                return;
            }

            let html = '';
            symbols.forEach(symbol => {
                const symbolData = data[symbol];
                const exchanges = Object.keys(symbolData);
                
                if (exchanges.length === 0) return;

                // è®¡ç®—ä»·å·®ä¿¡æ¯ - å§‹ç»ˆè®¡ç®—å¹¶æ˜¾ç¤ºæœ€å¤§ä»·å·®
                const priceDiff = calculatePriceDifference(symbolData);
                let priceDiffDisplay = '';
                
                if (priceDiff && priceDiff.diffPercent >= 0.01) { // æ˜¾ç¤ºä»·å·®å¤§äº0.01%çš„æƒ…å†µ
                    // æ ¹æ®æœ€é«˜/æœ€ä½çš„ç±»å‹é€‰æ‹©æ ·å¼
                    let styleClass = 'price-diff-style-1';
                    if (priceDiff.maxType === 'spot' && priceDiff.minType === 'spot') {
                        styleClass = 'price-diff-style-1';
                    } else if (priceDiff.maxType === 'spot' && priceDiff.minType === 'futures') {
                        styleClass = 'price-diff-style-2';
                    } else if (priceDiff.maxType === 'futures' && priceDiff.minType === 'spot') {
                        styleClass = 'price-diff-style-3';
                    } else if (priceDiff.maxType === 'futures' && priceDiff.minType === 'futures') {
                        styleClass = 'price-diff-style-4';
                    }

                    const timeDiff = calculateTimeDifference(priceDiff.maxTimestamp, priceDiff.minTimestamp);
                    priceDiffDisplay = `
                        <div class="price-diff-banner ${styleClass}">
                            <div class="diff-left">
                                <span class="diff-label">æœ€å¤§ä»·å·®</span>
                                <span class="diff-percent">${parseFloat(priceDiff.diffPercent.toFixed(4))}%</span>
                            </div>
                            <div class="diff-right diff-meta">
                                <div class="high">é«˜: ${priceDiff.maxExchange} <small style="opacity:0.8">${formatTimestamp(priceDiff.maxTimestamp)}</small></div>
                                <div class="low">ä½: ${priceDiff.minExchange} <small style="opacity:0.8">${formatTimestamp(priceDiff.minTimestamp)}</small></div>
                                <div style="font-size:10px;opacity:0.7;margin-top:2px;">æ—¶é—´å·®: ${timeDiff}</div>
                            </div>
                        </div>
                    `;
                }

                html += `
                    <div class="symbol-card" onclick="goToSymbolDetails('${symbol}')" style="cursor: pointer;">
                        <div class="symbol-header">
                            <div class="symbol-name">${symbol} <span style="font-size:12px;color:#f0b90b;font-weight:600;">ğŸ“Š è¯¦æƒ…</span></div>
                            <div class="exchange-count">${exchanges.length} äº¤æ˜“æ‰€</div>
                        </div>
                        ${priceDiffDisplay}
                        <div class="exchanges-grid">
                `;

                ['binance', 'okx', 'bybit', 'bitget'].forEach(exchange => {
                    if (symbolData[exchange]) {
                        const exData = symbolData[exchange];
                        const hasSpot = exData.spot && exData.spot.price;
                        const hasFutures = exData.futures && exData.futures.price;
                        const fundingRate = exData.futures ? exData.futures.funding_rate : null;

                        html += `
                            <div class="exchange-box">
                                <div class="exchange-name">${exchange}</div>
                                <div class="price-info">
                        `;

                        if (hasSpot) {
                            html += `
                                <div class="price-row">
                                    <span class="price-label">ç°è´§</span>
                                    <span class="price-value">${formatPrice(exData.spot.price)}</span>
                                </div>
                                <div class="price-row" style="font-size:10px;opacity:0.7;">
                                    <span class="price-label">ç°è´§æ›´æ–°</span>
                                    <span class="price-value">${formatTimestamp(exData.spot.timestamp)}</span>
                                </div>
                            `;
                        }

                        if (hasFutures) {
                            html += `
                                <div class="price-row">
                                    <span class="price-label">æœŸè´§</span>
                                    <span class="price-value">${formatPrice(exData.futures.price)}</span>
                                </div>
                                <div class="price-row" style="font-size:10px;opacity:0.7;">
                                    <span class="price-label">æœŸè´§æ›´æ–°</span>
                                    <span class="price-value">${formatTimestamp(exData.futures.timestamp)}</span>
                                </div>
                            `;
                        }

                        if (fundingRate) {
                            html += `
                                <div class="price-row">
                                    <span class="price-label">è´¹ç‡</span>
                                    <span class="funding-rate ${getFundingRateClass(fundingRate)}">${formatFundingRate(fundingRate)}</span>
                                </div>
                            `;
                        }

                        if (!hasSpot && !hasFutures) {
                            html += '<div class="price-row"><span class="price-label">æš‚æ— æ•°æ®</span></div>';
                        }

                        html += `
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="exchange-box" style="opacity: 0.3;">
                                <div class="exchange-name">${exchange}</div>
                                <div class="price-info">
                                    <div class="price-row">
                                        <span class="price-label">æœªæ”¯æŒ</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });

                html += `
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // åº”ç”¨è¿‡æ»¤å™¨
        function applyFilters() {
            let filtered = { ...allData };
            
            // æœç´¢è¿‡æ»¤
            if (currentSearch.trim()) {
                const searchTerm = currentSearch.trim().toLowerCase();
                filtered = Object.keys(filtered)
                    .filter(symbol => symbol.toLowerCase().includes(searchTerm))
                    .reduce((obj, key) => {
                        obj[key] = filtered[key];
                        return obj;
                    }, {});
            }
            
            // åˆ†ç±»è¿‡æ»¤
            if (currentFilter !== 'all') {
                filtered = Object.keys(filtered)
                    .filter(symbol => {
                        const symbolData = filtered[symbol];
                        const exchanges = Object.keys(symbolData);
                        
                        switch (currentFilter) {
                            case 'hasData':
                                return exchanges.some(ex => {
                                    const exData = symbolData[ex];
                                    return (exData.spot && exData.spot.price) || (exData.futures && exData.futures.price);
                                });
                            case 'multiExchange':
                                return exchanges.length >= 2;
                            case 'hasFunding':
                                return exchanges.some(ex => {
                                    const exData = symbolData[ex];
                                    return exData.futures && exData.futures.funding_rate;
                                });
                            case 'priceDiff':
                                // ä»·å·®ç­›é€‰ï¼šéœ€è¦æœ‰å¤šä¸ªæœ‰æ•ˆä»·æ ¼ä¸”ä»·å·®å¤§äº0.1%
                                const diff = calculatePriceDifference(symbolData);
                                return diff && diff.diffPercent >= 0.1;
                            case 'wlfi':
                                return symbol.toLowerCase().includes('wlfi');
                            case 'mainstream':
                                return mainstreamSymbols.includes(symbol);
                            default:
                                return true;
                        }
                    })
                    .reduce((obj, key) => {
                        obj[key] = filtered[key];
                        return obj;
                    }, {});
            }
            
            filteredData = filtered;
            updateSymbolsGrid(filteredData);
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalSymbols = Object.keys(allData).length;
            const dataSymbols = Object.keys(allData).filter(symbol => {
                const symbolData = allData[symbol];
                const exchanges = Object.keys(symbolData);
                return exchanges.some(ex => {
                    const exData = symbolData[ex];
                    return (exData.spot && exData.spot.price) || (exData.futures && exData.futures.price);
                });
            }).length;
            
            document.getElementById('totalSymbols').textContent = totalSymbols.toLocaleString();
            document.getElementById('dataSymbols').textContent = dataSymbols.toLocaleString();
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // æ›´æ–°RESTçŠ¶æ€
        async function fetchSystemStatus() {
            try {
                const res = await fetch('/api/system/status');
                const s = await res.json();
                const last = (s && s.rest && s.rest.last_sync) || {};
                const map = {
                    binance: document.getElementById('rest-binance'),
                    okx: document.getElementById('rest-okx'),
                    bybit: document.getElementById('rest-bybit'),
                    bitget: document.getElementById('rest-bitget')
                };
                Object.keys(map).forEach(ex => {
                    const ts = last[ex];
                    map[ex].textContent = ts ? formatTimestamp(ts) : '-';
                });
            } catch (e) {
                // å¿½ç•¥ä¸€æ¬¡æ€§é”™è¯¯
            }
        }

        // è·å–èšåˆæ•°æ®
        async function fetchAggregatedData() {
            try {
                const response = await fetch('/api/aggregated_data');
                const data = await response.json();
                
                allData = data.aggregated_data || {};
                applyFilters();
                
            } catch (error) {
                console.error('æ•°æ®è·å–é”™è¯¯:', error);
                document.getElementById('symbolsGrid').innerHTML = 
                    '<div class="loading" style="color: #ef4444;">âš ï¸ æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>';
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°
        function refreshData() {
            fetchAggregatedData();
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            isAutoRefresh = !isAutoRefresh;
            const btn = document.querySelector('.control-btn:nth-child(2)');
            if (isAutoRefresh) {
                btn.textContent = 'â¸ï¸ æš‚åœ';
                startAutoRefresh();
            } else {
                btn.textContent = 'â–¶ï¸ å¼€å§‹';
                clearInterval(refreshInterval);
            }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(() => {
                if (isAutoRefresh) {
                    fetchAggregatedData();
                    fetchSystemStatus();
                }
            }, 1000); // 1ç§’åˆ·æ–°
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // æœç´¢æ¡†äº‹ä»¶
            document.getElementById('searchInput').addEventListener('input', function(e) {
                currentSearch = e.target.value;
                // æœç´¢å±äºç”¨æˆ·æ“ä½œï¼šè§¦å‘ä¸€æ¬¡æ€§é‡æ’
                forceResort = true;
                applyFilters();
            });
            
            // è¿‡æ»¤æ ‡ç­¾äº‹ä»¶
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    // è¿‡æ»¤æ ‡ç­¾ç‚¹å‡»å±äºç”¨æˆ·æ“ä½œï¼šè§¦å‘ä¸€æ¬¡æ€§é‡æ’
                    forceResort = true;
                    applyFilters();
                });
            });
            
            // åˆå§‹åŒ–æ•°æ®
            fetchAggregatedData();
            fetchSystemStatus();
            startAutoRefresh();
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                clearInterval(refreshInterval);
            } else if (isAutoRefresh) {
                startAutoRefresh();
            }
        });

        // è·³è½¬åˆ°å¸ç§è¯¦æƒ…é¡µé¢
        function goToSymbolDetails(symbol) {
            window.location.href = `/charts?symbol=${symbol}`;
        }
    </script>
</body>
</html>
