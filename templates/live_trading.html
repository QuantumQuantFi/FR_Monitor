<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>实盘交易（Type B）</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 16px; background: #0d1421; color: #e6edf3; }
    a { color: #58a6ff; text-decoration: none; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .card { background: #111a2a; border: 1px solid #263040; border-radius: 10px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .muted { color: #8b949e; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #263040; }
    .pill.ok { background: rgba(35,134,54,0.2); border-color: rgba(35,134,54,0.6); }
    .pill.warn { background: rgba(227,179,65,0.18); border-color: rgba(227,179,65,0.6); }
    .pill.bad { background: rgba(248,81,73,0.18); border-color: rgba(248,81,73,0.6); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #263040; vertical-align: top; }
    th { text-align: left; position: sticky; top: 0; background: #111a2a; z-index: 1; }
    .table-wrap { overflow: auto; max-height: 60vh; border: 1px solid #263040; border-radius: 10px; }
    button { background: #1f6feb; border: 1px solid #2f81f7; color: #fff; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    button.secondary { background: #21262d; border-color: #30363d; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input { background: #0b1220; border: 1px solid #263040; color: #e6edf3; border-radius: 8px; padding: 6px 10px; }
    select { background: #0b1220; border: 1px solid #263040; color: #e6edf3; border-radius: 8px; padding: 6px 10px; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; background: #0b1220; border: 1px solid #263040; border-radius: 10px; padding: 10px; max-height: 35vh; overflow: auto; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    .hint { border-bottom: 1px dotted #8b949e; cursor: help; }
    .sort-btn { display: inline-block; padding: 0 4px; margin-left: 4px; border: 1px solid #263040; border-radius: 6px; color: #8b949e; cursor: pointer; user-select: none; font-size: 11px; line-height: 16px; }
    .sort-btn:hover { color: #e6edf3; border-color: #3b4a60; }
    .sort-btn.active { color: #e6edf3; border-color: #58a6ff; }
  </style>
</head>
<body>
  <div class="row" style="justify-content: space-between; margin-bottom: 12px;">
    <div>
      <div style="font-size: 18px; font-weight: 700;">实盘交易（Type B）</div>
      <div class="muted" style="margin-top: 4px;">订单簿 1min 监听 → 达到 0.8*pnl_hat 止盈 / 1 天强平 → 平仓下单 → 落库</div>
    </div>
    <div class="row">
      <a href="/watchlist">Watchlist</a>
      <a href="/watchlist/db">PG DB</a>
    </div>
  </div>

  <div class="card" style="margin-bottom: 12px;">
    <div class="row">
      <span id="enabledPill" class="pill">loading</span>
      <span class="muted">更新时间：</span><span id="ts" class="muted">-</span>
      <span class="muted" style="margin-left: 12px;">配置：</span><span id="cfg" class="muted">-</span>
      <span class="muted" style="margin-left: 12px;">刷新间隔(s)：</span>
      <input id="refreshSec" type="number" min="2" max="300" value="10" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">信号条数：</span>
      <input id="signalsLimit" type="number" min="10" max="2000" value="500" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">筛选：</span>
      <input id="filterSymbol" placeholder="symbol(可选)" style="width: 110px;" />
      <div id="statusFilterWrap" style="position: relative;">
        <button id="statusFilterBtn" class="secondary" type="button" title="status(可选)；点击后在下拉里打勾" style="padding: 6px 10px;">
          <span id="statusFilterLabel" class="muted">status(全部)</span>
        </button>
        <div id="statusFilterMenu" class="card" style="display:none; position:absolute; top: 42px; left:0; z-index: 5; min-width: 180px; padding: 10px;">
          <div class="row" style="justify-content: space-between; margin-bottom: 6px;">
            <span class="muted">Status</span>
            <div class="row" style="gap: 6px;">
              <button id="statusSelectAllBtn" class="secondary" type="button" style="padding: 4px 8px;">全选</button>
              <button id="statusClearBtn" class="secondary" type="button" style="padding: 4px 8px;">清空</button>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px;">
            <label class="muted"><input class="status-cb" type="checkbox" value="new"> new</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="skipped"> skipped</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="opening"> opening</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="open"> open</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="closing"> closing</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="closed"> closed</label>
            <label class="muted"><input class="status-cb" type="checkbox" value="failed"> failed</label>
          </div>
        </div>
      </div>
      <select id="filterType" title="signal_type(可选)" style="width: 120px;">
        <option value="">type(全部)</option>
        <option value="B">B</option>
      </select>
      <input id="filterExchange" placeholder="exchange(可选)" style="width: 120px;" />
      <button id="refreshBtn" class="secondary">立即刷新</button>
      <button id="resetBtn" class="secondary">清空筛选</button>
      <button id="posBtn" class="secondary">刷新持仓(私有API)</button>
    </div>
    <div class="row" style="margin-top: 8px;">
      <span class="muted">预计收益(pnl_hat_ob)：</span>
      <input id="filterPnlMin" type="number" step="0.0001" placeholder="min" style="width: 90px;" />
      <input id="filterPnlMax" type="number" step="0.0001" placeholder="max" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">胜率(win_prob_ob)：</span>
      <input id="filterProbMin" type="number" step="0.0001" placeholder="min" style="width: 90px;" />
      <input id="filterProbMax" type="number" step="0.0001" placeholder="max" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">RealizedPnL(USDT)：</span>
      <input id="filterRealMin" type="number" step="0.0001" placeholder="min" style="width: 100px;" />
      <input id="filterRealMax" type="number" step="0.0001" placeholder="max" style="width: 100px;" />
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
        <div style="font-weight: 700;">交易信号 / 状态</div>
        <div class="muted">点击 Details 查看 orders/samples（含成交均价/数量摘要）</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width: 64px;">ID</th>
              <th style="width: 90px;">event_id</th>
              <th style="width: 90px;">Symbol</th>
              <th style="width: 90px;">Type</th>
              <th style="width: 200px;">Exchanges</th>
              <th style="width: 120px;">
                <span class="hint" title="交易所A（Long腿）开仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">A Long 开仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所A（Long腿）平仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">A Long 平仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所B（Short腿）开仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">B Short 开仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所B（Short腿）平仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">B Short 平仓价</span>
              </th>
              <th style="width: 130px;">
                <span class="hint" title="开仓“实际价差”（百分比）：用两条腿的开仓成交均价估算，entry_spread_pct_actual = (B_short开仓价 / A_long开仓价) - 1。用于复盘滑点/下单时刻价差是否真实存在。">开仓价差%</span>
              </th>
              <th style="width: 150px;">
                <span class="hint" title="预计达到止盈条件时的“平仓临界价差”（百分比）：与实际止盈判断口径一致（使用开仓时订单簿扫盘得到的 entry_spread_metric）。计算：take_profit_exit_spread_pct = exp(entry_spread_metric - tp_pnl) - 1。含义：当后续平仓方向订单簿可成交价差 short_buy/long_sell 收敛到该水平附近，则 last_pnl≈tp_pnl，进入止盈判定。">止盈临界价差%</span>
              </th>
              <th style="width: 130px;">
                <span class="hint" title="实际盈亏（USDT，未计资金费/手续费）：按两条腿的开/平仓成交均价和成交数量估算。Long腿：(close-open)*qty；Short腿：(open-close)*qty；qty 取开/平两侧 filled_qty 的最小值。">realized_pnl</span>
              </th>
              <th style="width: 140px;">
                <span class="hint" title="FundingPnL(USDT)：从 opened_at 起，按交易所账户“已收/已付”资金费明细累加（两条腿叠加，best-effort；不同交易所回执字段不同，可能为空/延迟）。每小时整点后的首次刷新会更新一次（其余时间使用缓存）。">FundingPnL</span>
              </th>
              <th style="width: 90px;">Status</th>
              <th style="width: 110px;">
                <span class="hint" title="pnl_hat_ob：下单前用两家交易所订单簿“扫单成交价”（按每腿名义金额）重新计算关键因子，并在 horizon=240min 上回归预测得到的预计收益（小数，如 0.012=1.2%）。">pnl_hat_ob</span>
              </th>
              <th style="width: 110px;">
                <span class="hint" title="tp_pnl：止盈阈值（小数），默认 tp_pnl = take_profit_ratio * pnl_hat_ob（当前 take_profit_ratio=0.8）。当 last_pnl >= tp_pnl 时会进入“止盈候选”，系统会在几秒内再做两次订单簿复核（共3次）确认价差仍满足，才真正发起平仓；否则本次止盈作废，等待下一次监控判定。">tp_pnl</span>
              </th>
              <th style="width: 110px;">
                <span class="hint" title="last_pnl：最近一次 1min 监控样本计算的“订单簿估算PnL指标”（小数，口径为价差变化而非账户真实收益）。计算：last_pnl = entry_spread_metric - now_spread_metric，其中 entry_spread_metric=log(short_sell_entry/long_buy_entry)，now_spread_metric=log(short_buy_now/long_sell_now)。注意：不包含手续费/资金费/滑点/成交延迟，且若订单簿/合约口径与实际下单不一致，可能与 realized_pnl_usdt 显著偏离。">last_pnl</span>
              </th>
              <th style="width: 130px;">
                <span class="hint" title="实时平仓价差%：最近一次 1min 监控中，为“平仓方向”用订单簿扫盘得到的可成交价差（百分比）。计算：last_exit_spread_pct = (short_buy_px / long_sell_px) - 1，其中 long_sell_px=Long腿卖出(Bid扫盘价)，short_buy_px=Short腿买入(Ask扫盘价)。用于判断当前平仓可成交价差是否已明显收敛。">实时平仓价差%</span>
              </th>
              <th style="width: 170px;">created_at</th>
              <th style="width: 170px;">opened_at</th>
              <th style="width: 170px;">close_req_at</th>
              <th style="width: 170px;">closed_at</th>
              <th style="width: 170px;">force_close_at</th>
              <th style="width: 140px;">close_reason</th>
              <th style="width: 200px;">reason</th>
              <th style="width: 90px;">Details</th>
            </tr>
          </thead>
          <tbody id="signalsBody">
            <tr><td colspan="26" class="muted">loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div style="font-weight: 700; margin-bottom: 8px;">最近错误</div>
      <pre id="errorsPre" class="muted">loading...</pre>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
      <div style="font-weight: 700;">持仓 / 余额（私有 API）</div>
      <div class="muted">用于排查“残留持仓/余额不足”；可对无 open 信号的持仓手动一键平仓</div>
    </div>
    <div class="row" style="margin-bottom: 8px;">
      <button id="posBtn2" class="secondary">查询全部交易所持仓/余额</button>
      <label class="muted" style="display:flex;align-items:center;gap:6px;">
        <input id="posNonzeroOnly" type="checkbox" checked />
        仅显示非零持仓
      </label>
      <span id="posTs" class="muted">-</span>
    </div>
    <div class="row" style="gap: 12px; align-items: stretch;">
      <div style="flex: 1; min-width: 340px;">
        <div class="muted" style="margin-bottom: 6px;">余额摘要</div>
        <div class="table-wrap" style="max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th style="width: 120px;">Exchange</th>
                <th style="width: 100px;">Currency</th>
                <th style="width: 140px;">Available</th>
                <th style="width: 140px;">Wallet/Equity</th>
                <th style="width: 200px;">Error</th>
              </tr>
            </thead>
            <tbody id="balancesBody">
              <tr><td colspan="5" class="muted">点击“查询全部交易所持仓/余额”</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <div style="flex: 2; min-width: 520px;">
        <div class="muted" style="margin-bottom: 6px;">当前持仓（永续）</div>
        <div class="table-wrap" style="max-height: 260px;">
          <table>
            <thead>
              <tr>
                <th style="width: 140px;">
                  Exchange
                  <span class="sort-btn" id="sortExAsc" onclick="setPositionsSort('exchange','asc')">▲</span>
                  <span class="sort-btn" id="sortExDesc" onclick="setPositionsSort('exchange','desc')">▼</span>
                </th>
                <th style="width: 140px;">
                  Symbol
                  <span class="sort-btn" id="sortSymAsc" onclick="setPositionsSort('symbol','asc')">▲</span>
                  <span class="sort-btn" id="sortSymDesc" onclick="setPositionsSort('symbol','desc')">▼</span>
                </th>
                <th style="width: 90px;">Side</th>
                <th style="width: 140px;">Size</th>
                <th style="width: 160px;">Value(USDT)</th>
                <th style="width: 140px;">Entry</th>
                <th style="width: 140px;">
                  <span class="hint" title="标记价格：用于估值/UPnL 的参考价格（best-effort，从公开接口获取；不同交易所口径略有差异）。">Mark</span>
                </th>
                <th style="width: 140px;">
                  <span class="hint" title="当前资金费率（每个 funding 周期的费率，正值多付空收/负值多收空付，具体以交易所定义为准）。">Funding</span>
                </th>
                <th style="width: 120px;">
                  <span class="hint" title="资金费结算周期（小时）。例如多数 CEX perp 为 8h，Hyperliquid 为 1h。">Interval(h)</span>
                </th>
                <th style="width: 140px;">
                  <span class="hint" title="距离下一次资金费结算剩余时间（按公开接口 next_funding_time 计算）。">Next</span>
                </th>
                <th style="width: 140px;">
                  <span class="hint" title="FundingPnL(USDT)：若该持仓能匹配到我们系统的 open 信号，则按 opened_at 起累计该币种资金费（best-effort，来自交易所账户资金费明细）。否则为空。">FundingPnL</span>
                </th>
                <th style="width: 140px;">
                  <span class="hint" title="LastFee(USDT)：最近一次资金费入账/扣款金额（best-effort），hover 可查看 opened_at/last_time 等。">LastFee</span>
                </th>
                <th style="width: 140px;">UPnL(USDT)</th>
                <th style="width: 120px;">Action</th>
              </tr>
            </thead>
            <tbody id="positionsBody">
              <tr><td colspan="14" class="muted">点击“查询全部交易所持仓/余额”</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <div class="muted" style="margin-top: 8px;">
      说明：一键平仓会先检查该币种是否存在 open/opening/closing 的信号；若存在则拒绝（避免干扰自动策略）。
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
      <div style="font-weight: 700;">Details</div>
      <div class="muted">orders / samples / positions（按需加载）</div>
    </div>
    <pre id="detailsSummary" class="muted" style="margin-bottom: 8px;">点击某个 signal 的 Details 按钮</pre>
    <pre id="detailsPre" class="muted">-</pre>
  </div>

  <script>
    let refreshTimer = null;
    let positionsCache = [];
    let positionsSort = {key: null, dir: null};

    function fmt(v, nd=6) {
      if (v === null || v === undefined) return '-';
      const n = Number(v);
      if (!Number.isFinite(n)) return String(v);
      return n.toFixed(nd);
    }

    function fmtPct(v, nd=4) {
      if (v === null || v === undefined) return '-';
      const n = Number(v);
      if (!Number.isFinite(n)) return String(v);
      return (n * 100).toFixed(nd) + '%';
    }

    function fmtTsBJ(iso) {
      if (!iso || iso === '-') return '-';
      const t = Date.parse(String(iso));
      if (!Number.isFinite(t)) return String(iso);
      try {
        const parts = new Intl.DateTimeFormat('zh-CN', {
          timeZone: 'Asia/Shanghai',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false,
        }).formatToParts(new Date(t));
        const get = (type) => (parts.find(p => p.type === type) || {}).value || '';
        return `${get('year')}-${get('month')}-${get('day')} ${get('hour')}:${get('minute')}:${get('second')}`;
      } catch (e) {
        return new Date(t).toLocaleString();
      }
    }

    function fmtCountdown(iso) {
      if (!iso) return '-';
      const t = Date.parse(String(iso));
      if (!Number.isFinite(t)) return '-';
      const now = Date.now();
      let diff = Math.floor((t - now) / 1000);
      if (diff < 0) diff = 0;
      const d = Math.floor(diff / 86400);
      diff -= d * 86400;
      const h = Math.floor(diff / 3600);
      diff -= h * 3600;
      const m = Math.floor(diff / 60);
      const s = diff - m * 60;
      if (d > 0) return `${d}d${h}h`;
      if (h > 0) return `${h}h${String(m).padStart(2, '0')}m`;
      return `${m}m${String(s).padStart(2, '0')}s`;
    }

    function escapeHtml(s) {
      return String(s || '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function pillForStatus(status) {
      const s = (status || '').toLowerCase();
      if (s === 'open') return ['open', 'ok'];
      if (s === 'opening' || s === 'closing') return [s, 'warn'];
      if (s === 'closed') return ['closed', 'ok'];
      if (s === 'failed') return ['failed', 'bad'];
      return [status || '-', ''];
    }

    async function fetchJson(url) {
      const resp = await fetch(url, {cache: 'no-store'});
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || resp.statusText);
      return data;
    }

    async function postJson(url, body) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body || {}),
        cache: 'no-store',
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || resp.statusText);
      return data;
    }

    async function refresh() {
      const overview = await fetchJson('/api/live_trading/overview?limit=80');
      const limit = Math.max(10, Math.min(2000, Number(document.getElementById('signalsLimit').value || 500)));
      const symbol = (document.getElementById('filterSymbol').value || '').trim();
      const statuses = Array.from(document.querySelectorAll('.status-cb:checked')).map(cb => (cb.value || '').trim()).filter(v => v);
      const type = (document.getElementById('filterType').value || '').trim();
      const exchange = (document.getElementById('filterExchange').value || '').trim();
      const pnlMin = (document.getElementById('filterPnlMin').value || '').trim();
      const pnlMax = (document.getElementById('filterPnlMax').value || '').trim();
      const probMin = (document.getElementById('filterProbMin').value || '').trim();
      const probMax = (document.getElementById('filterProbMax').value || '').trim();
      const realMin = (document.getElementById('filterRealMin').value || '').trim();
      const realMax = (document.getElementById('filterRealMax').value || '').trim();
      const qs = new URLSearchParams({limit: String(limit)});
      if (symbol) qs.set('symbol', symbol);
      for (const st of statuses) qs.append('status', st);
      if (type) qs.set('signal_type', type);
      if (exchange) qs.set('exchange', exchange);
      if (pnlMin) qs.set('pnl_hat_ob_min', pnlMin);
      if (pnlMax) qs.set('pnl_hat_ob_max', pnlMax);
      if (probMin) qs.set('win_prob_ob_min', probMin);
      if (probMax) qs.set('win_prob_ob_max', probMax);
      if (realMin) qs.set('realized_pnl_min', realMin);
      if (realMax) qs.set('realized_pnl_max', realMax);
      const signalsResp = await fetchJson(`/api/live_trading/signals?${qs.toString()}`);
      document.getElementById('ts').textContent = overview.timestamp || '-';
      const cfg = overview.live_trading_config || {};
      document.getElementById('cfg').textContent = `per_leg=${cfg.per_leg_notional_usdt || '-'} horizon=${cfg.horizon_min || '-'} pnl>=${cfg.pnl_threshold || '-'} prob>=${cfg.win_prob_threshold || '-'} lookback=${cfg.event_lookback_minutes || '-'}m ex=${cfg.allowed_exchanges || '-'}`;

      const enabled = !!overview.live_trading_enabled;
      const pill = document.getElementById('enabledPill');
      pill.textContent = enabled ? 'LIVE_TRADING_ENABLED=1' : 'LIVE_TRADING_ENABLED=0';
      pill.className = 'pill ' + (enabled ? 'ok' : 'warn');

      const errors = (overview.errors || []).slice(0, 30);
      document.getElementById('errorsPre').textContent = JSON.stringify(errors, null, 2);

      const body = document.getElementById('signalsBody');
      const signals = signalsResp.signals || [];
      if (!signals.length) {
        body.innerHTML = '<tr><td colspan="26" class="muted">暂无数据</td></tr>';
        return;
      }

      body.innerHTML = signals.map(s => {
        const [stText, stCls] = pillForStatus(s.status);
        const ex = `${s.leg_long_exchange || '-'}(long) / ${s.leg_short_exchange || '-'}(short)`;
        const aOpen = fmt(s.open_long_avg_price, 8);
        const aClose = fmt(s.close_long_avg_price, 8);
        const bOpen = fmt(s.open_short_avg_price, 8);
        const bClose = fmt(s.close_short_avg_price, 8);
        const entrySpreadPct = fmtPct(s.entry_spread_pct_actual, 4);
        const tpExitSpreadPct = fmtPct(s.take_profit_exit_spread_pct, 4);
        const realized = fmt(s.realized_pnl_usdt, 6);
        const exitSpreadPctNow = fmtPct(s.last_exit_spread_pct, 4);
        const src = s.funding_source || {};
        const hasEst = (src.long === 'rate_estimate') || (src.short === 'rate_estimate');
        const fundingPnl = (hasEst ? '~' : '') + fmt(s.funding_pnl_usdt, 6);
        const schedL = s.funding_schedule_long || {};
        const schedS = s.funding_schedule_short || {};
        const fundingTitle = [
          `funding_pnl_usdt_total=${s.funding_pnl_usdt ?? '-'}`,
          `source_long=${src.long ?? '-'} source_short=${src.short ?? '-'}`,
          `long(${s.leg_long_exchange || '-'}) pnl=${s.funding_long_pnl_usdt ?? '-'} last_fee=${s.funding_long_last_fee_usdt ?? '-'} last_time=${s.funding_long_last_fee_time ?? '-'} rate=${schedL.funding_rate ?? '-'} interval_h=${schedL.funding_interval_hours ?? '-'} next=${schedL.next_funding_time ?? '-'}`,
          `short(${s.leg_short_exchange || '-'}) pnl=${s.funding_short_pnl_usdt ?? '-'} last_fee=${s.funding_short_last_fee_usdt ?? '-'} last_time=${s.funding_short_last_fee_time ?? '-'} rate=${schedS.funding_rate ?? '-'} interval_h=${schedS.funding_interval_hours ?? '-'} next=${schedS.next_funding_time ?? '-'}`,
          s.funding_error ? `error=${JSON.stringify(s.funding_error)}` : '',
	        ].filter(Boolean).join('\n');
	        const canForceClose = true;
	        const createdAtUtc = s.created_at || '-';
	        const openAtUtc = s.opened_at || '-';
	        const closeReqAtUtc = s.close_requested_at || '-';
	        const closedAtUtc = s.closed_at || '-';
	        const forceAtUtc = s.force_close_at || '-';
	        const createdAt = fmtTsBJ(createdAtUtc);
	        const openAt = fmtTsBJ(openAtUtc);
	        const closeReqAt = fmtTsBJ(closeReqAtUtc);
	        const closedAt = fmtTsBJ(closedAtUtc);
	        const forceAt = fmtTsBJ(forceAtUtc);
	        const closeReason = s.close_reason || '-';
	        const reason = s.reason || '-';
	        return `
	          <tr>
            <td>${s.id}</td>
            <td class="muted">${s.event_id || '-'}</td>
            <td>${s.symbol || '-'}</td>
            <td class="muted">${s.signal_type || '-'}</td>
            <td class="muted">${ex}</td>
            <td class="muted">${aOpen}</td>
            <td class="muted">${aClose}</td>
            <td class="muted">${bOpen}</td>
            <td class="muted">${bClose}</td>
            <td class="muted">${entrySpreadPct}</td>
            <td class="muted">${tpExitSpreadPct}</td>
            <td class="muted">${realized}</td>
            <td class="muted"><span class="hint" title="${escapeHtml(fundingTitle)}">${fundingPnl}</span></td>
            <td><span class="pill ${stCls}">${stText}</span></td>
            <td>${fmt(s.pnl_hat_ob, 6)}</td>
            <td>${fmt(s.take_profit_pnl, 6)}</td>
            <td>${fmt(s.last_pnl_spread, 6)}</td>
            <td class="muted">${exitSpreadPctNow}</td>
	            <td class="muted" title="UTC: ${escapeHtml(createdAtUtc)}">${createdAt}</td>
	            <td class="muted" title="UTC: ${escapeHtml(openAtUtc)}">${openAt}</td>
	            <td class="muted" title="UTC: ${escapeHtml(closeReqAtUtc)}">${closeReqAt}</td>
	            <td class="muted" title="UTC: ${escapeHtml(closedAtUtc)}">${closedAt}</td>
	            <td class="muted" title="UTC: ${escapeHtml(forceAtUtc)}">${forceAt}</td>
	            <td class="muted">${closeReason}</td>
	            <td class="muted">${reason}</td>
	            <td>
	              <button class="secondary" onclick="loadDetails(${s.id})">Details</button>
              <button class="secondary" ${canForceClose ? '' : 'disabled'} onclick="forceClose(${s.id})">一键平仓</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function setPositionsSort(key, dir) {
      positionsSort = {key, dir};
      const btns = ['sortExAsc', 'sortExDesc', 'sortSymAsc', 'sortSymDesc'];
      for (const id of btns) document.getElementById(id)?.classList.remove('active');
      if (key === 'exchange' && dir === 'asc') document.getElementById('sortExAsc')?.classList.add('active');
      if (key === 'exchange' && dir === 'desc') document.getElementById('sortExDesc')?.classList.add('active');
      if (key === 'symbol' && dir === 'asc') document.getElementById('sortSymAsc')?.classList.add('active');
      if (key === 'symbol' && dir === 'desc') document.getElementById('sortSymDesc')?.classList.add('active');
      renderPositionsTable();
    }

    function renderPositionsTable() {
      const positionsBody = document.getElementById('positionsBody');
      const rows = (positionsCache || []).slice();

      if (positionsSort?.key) {
        const key = positionsSort.key;
        const dir = positionsSort.dir === 'desc' ? -1 : 1;
        rows.sort((a, b) => {
          const av = (a?.[key] ?? '').toString();
          const bv = (b?.[key] ?? '').toString();
          return av.localeCompare(bv) * dir;
        });
      }

      if (!rows.length) {
        positionsBody.innerHTML = '<tr><td colspan="14" class="muted">暂无持仓（或查询失败）</td></tr>';
        return;
      }

      positionsBody.innerHTML = rows.map(p => {
        const entry = fmt(p.entry, 8);
        const value = fmt(p.value_usdt, 4);
        const upnl = fmt(p.upnl_usdt, 6);
        const size = fmt(p.size, 8);
        const mark = fmt(p.mark_price, 8);
        const fr = fmtPct(p.funding_rate, 4);
        const interval = fmt(p.funding_interval_hours, 2);
        const next = fmtCountdown(p.next_funding_time);
        const nextTitle = p.next_funding_time ? `next_funding_time=${p.next_funding_time}` : '';
        const feeSrc = p.funding_source || null;
        const feePnl = (feeSrc === 'rate_estimate' ? '~' : '') + fmt(p.funding_pnl_usdt, 6);
        const lastFee = fmt(p.funding_last_fee_usdt, 6);
        const feeTitle = [
          `opened_at=${p.funding_opened_at || '-'}`,
          `funding_pnl_usdt=${p.funding_pnl_usdt ?? '-'}`,
          `last_fee_usdt=${p.funding_last_fee_usdt ?? '-'}`,
          `last_fee_time=${p.funding_last_fee_time || '-'}`,
          `source=${feeSrc || '-'}`,
          p.funding_fee_error ? `error=${p.funding_fee_error}` : '',
        ].filter(Boolean).join('\n');
        return `
          <tr>
            <td>${p.exchange}</td>
            <td>${p.symbol}</td>
            <td class="muted">${p.side}</td>
            <td class="muted">${size}</td>
            <td class="muted">${value}</td>
            <td class="muted">${entry}</td>
            <td class="muted">${mark}</td>
            <td class="muted">${fr}</td>
            <td class="muted">${interval}</td>
            <td class="muted" title="${nextTitle}">${next}</td>
            <td class="muted"><span class="hint" title="${escapeHtml(feeTitle)}">${feePnl}</span></td>
            <td class="muted"><span class="hint" title="${escapeHtml(feeTitle)}">${lastFee}</span></td>
            <td class="muted">${upnl}</td>
            <td>
              <button class="secondary" onclick="flattenPosition('${p.exchange}','${p.symbol}')">一键平仓</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function forceClose(signalId) {
      if (!confirm(`确认一键平仓 signal_id=${signalId} ?\\n\\n将同时查询两交易所持仓并以 reduce-only 市价打平。\\n若该 symbol 存在其他 open/opening/closing 信号，将拒绝执行。`)) return;
      const detailsPre = document.getElementById('detailsPre');
      const detailsSummary = document.getElementById('detailsSummary');
      detailsSummary.textContent = `force closing signal_id=${signalId} ...`;
      detailsPre.textContent = '...';
      try {
        const resp = await postJson('/api/live_trading/force_close', {signal_id: signalId});
        detailsSummary.textContent = JSON.stringify(resp.result || resp, null, 2);
        detailsPre.textContent = JSON.stringify(resp, null, 2);
        await refresh();
      } catch (e) {
        detailsSummary.textContent = String(e);
        detailsPre.textContent = String(e);
      }
    }

    function renderPositionsAndBalances(payload) {
      const rows = payload?.results || [];
      const balancesBody = document.getElementById('balancesBody');
      const positionsBody = document.getElementById('positionsBody');

      function pickBalanceFields(bal) {
        if (!bal || typeof bal !== 'object') return {currency: '-', avail: '-', wallet: '-'};
        const currency = bal.currency || '-';
        const avail = bal.available_balance ?? bal.avail_bal ?? bal.withdrawable ?? '-';
        const wallet = bal.wallet_balance ?? bal.equity ?? bal.account_value ?? bal.eq ?? bal.cash_bal ?? '-';
        return {currency, avail, wallet};
      }

      function normalizePosition(exchange, raw) {
        const ex = (exchange || '').toLowerCase();
        if (!raw || typeof raw !== 'object') return null;
        const markPrice = raw.mark_price ?? raw.markPrice ?? raw.markPx ?? raw.marketPrice ?? null;
        const fundingRate = raw.funding_rate ?? raw.fundingRate ?? null;
        const fundingInterval = raw.funding_interval_hours ?? raw.fundingIntervalHours ?? raw.fundingIntervalHour ?? null;
        const nextFunding = raw.next_funding_time ?? raw.nextFundingTime ?? raw.nextUpdate ?? null;
        const fundingPnl = raw.funding_pnl_usdt ?? null;
        const fundingLastFee = raw.funding_last_fee_usdt ?? null;
        const fundingLastTime = raw.funding_last_fee_time ?? null;
        const fundingOpenedAt = raw.funding_opened_at ?? null;
        const fundingSource = raw.funding_source ?? raw.fundingSource ?? null;
        const fundingFeeError = raw.funding_fee_error ?? raw.fundingFeeError ?? null;
        try {
          if (ex === 'binance') {
            const amt = Number(raw.positionAmt || 0);
            const sym = String(raw.symbol || '').replace(/USDT$/i, '') || '-';
            const mark = Number(raw.markPrice || 0);
            const notional = (raw.notional !== undefined && raw.notional !== null) ? Number(raw.notional) : (Math.abs(amt) * mark);
            return {exchange: ex, symbol: sym, side: amt >= 0 ? 'long' : 'short', size: Math.abs(amt), value_usdt: notional, entry: raw.entryPrice, upnl_usdt: raw.unRealizedProfit, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
          if (ex === 'okx') {
            const sz = Number(raw._base_size ?? raw.pos ?? raw.sz ?? 0);
            const posSide = String(raw.posSide || raw.side || 'net').toLowerCase();
            const sym = String(raw.instId || raw.symbol || '').split('-')[0] || '-';
            const signed = posSide === 'short' ? -Math.abs(sz) : Math.abs(sz);
            const mark = Number(raw.markPx || raw.last || 0);
            const notional = Math.abs(Number(raw.notionalUsd || 0)) || (Math.abs(signed) * mark);
            return {exchange: ex, symbol: sym, side: signed >= 0 ? 'long' : 'short', size: Math.abs(signed), value_usdt: notional, entry: raw.avgPx, upnl_usdt: raw.upl, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
          if (ex === 'bybit') {
            const sz = Number(raw.size || raw.qty || 0);
            const side = String(raw.side || '').toLowerCase(); // Buy/Sell
            const signed = side === 'sell' ? -Math.abs(sz) : Math.abs(sz);
            const sym = String(raw.symbol || '').replace(/USDT$/i, '') || '-';
            const mark = Number(raw.markPrice || 0);
            const notional = Number(raw.positionValue || 0) || (Math.abs(signed) * mark);
            return {exchange: ex, symbol: sym, side: signed >= 0 ? 'long' : 'short', size: Math.abs(signed), value_usdt: notional, entry: raw.avgPrice || raw.entryPrice, upnl_usdt: raw.unrealisedPnl || raw.unrealisedProfit, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
          if (ex === 'bitget') {
            const hold = String(raw.holdSide || '').toLowerCase();
            const q = Number(raw.available || raw.total || raw.openQty || raw.pos || 0);
            const signed = hold === 'short' ? -Math.abs(q) : Math.abs(q);
            const sym = String(raw.symbol || '').replace(/USDT$/i, '') || '-';
            const mark = Number(raw.marketPrice || raw.markPrice || 0);
            const notional = Number(raw.totalUSDT || raw.usdtValue || 0) || (Math.abs(signed) * mark);
            return {exchange: ex, symbol: sym, side: signed >= 0 ? 'long' : 'short', size: Math.abs(signed), value_usdt: notional, entry: raw.openPriceAvg || raw.avgOpenPrice, upnl_usdt: raw.unrealizedPL || raw.unrealisedPnl, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
          if (ex === 'hyperliquid') {
            const p = (raw.position && typeof raw.position === 'object') ? raw.position : raw;
            const szi = Number(p.szi || 0);
            const sym = String(p.coin || raw.coin || '-');
            const mark = Number(p.markPx || 0);
            const notional = Number(p.positionValue || 0) || (Math.abs(szi) * mark);
            return {exchange: ex, symbol: sym, side: szi >= 0 ? 'long' : 'short', size: Math.abs(szi), value_usdt: notional, entry: p.entryPx, upnl_usdt: p.unrealizedPnl, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
          if (ex === 'grvt') {
            const sz = Number(raw.size || 0);
            const inst = String(raw.instrument || raw.symbol || '');
            const sym = (inst && inst.includes('_')) ? inst.split('_')[0] : (inst || '-');
            const mark = Number(raw.mark_price || raw.markPrice || 0);
            const notional = Math.abs(Number(raw.notional || 0)) || (Math.abs(sz) * mark);
            return {exchange: ex, symbol: sym, side: sz >= 0 ? 'long' : 'short', size: Math.abs(sz), value_usdt: notional, entry: raw.entry_price || raw.entryPrice, upnl_usdt: raw.unrealized_pnl || raw.unrealizedPnl, mark_price: markPrice, funding_rate: fundingRate, funding_interval_hours: fundingInterval, next_funding_time: nextFunding, funding_pnl_usdt: fundingPnl, funding_last_fee_usdt: fundingLastFee, funding_last_fee_time: fundingLastTime, funding_opened_at: fundingOpenedAt, funding_source: fundingSource, funding_fee_error: fundingFeeError};
          }
        } catch (e) {
          return null;
        }
        return null;
      }

      // Balances
      if (!rows.length) {
        balancesBody.innerHTML = '<tr><td colspan="5" class="muted">暂无数据</td></tr>';
      } else {
        const totalMap = (payload && payload.balance_totals && typeof payload.balance_totals === 'object') ? payload.balance_totals : {};
        const totalsRows = Object.keys(totalMap || {}).sort().map(cur => {
          const t = totalMap[cur] || {};
          const a = (t.available !== undefined && t.available !== null) ? Number(t.available).toFixed(8).replace(/0+$/,'').replace(/\.$/,'') : '-';
          const w = (t.wallet !== undefined && t.wallet !== null) ? Number(t.wallet).toFixed(8).replace(/0+$/,'').replace(/\.$/,'') : '-';
          return `
            <tr style="border-top:1px solid #333;">
              <td><b>Total</b></td>
              <td class="muted"><b>${cur}</b></td>
              <td class="muted"><b>${a}</b></td>
              <td class="muted"><b>${w}</b></td>
              <td class="muted">-</td>
            </tr>
          `;
        });

        balancesBody.innerHTML = rows.map(r => {
          const ex = r.exchange || '-';
          const err = r.error || '';
          const b = pickBalanceFields(r.balance);
          return `
            <tr>
              <td>${ex}</td>
              <td class="muted">${b.currency}</td>
              <td class="muted">${b.avail}</td>
              <td class="muted">${b.wallet}</td>
              <td class="muted">${err || '-'}</td>
            </tr>
          `;
        }).join('') + totalsRows.join('');
      }

      // Positions
      const posRows = [];
      for (const r of rows) {
        const ex = r.exchange;
        const err = r.error;
        if (err) continue;
        const ps = Array.isArray(r.positions) ? r.positions : [];
        for (const p of ps) {
          const n = normalizePosition(ex, p);
          if (!n) continue;
          if (!n.symbol || n.symbol === '-') continue;
          if (!Number.isFinite(Number(n.size)) || Number(n.size) <= 0) continue;
          posRows.push(n);
        }
      }

      if (!posRows.length) {
        positionsCache = [];
        renderPositionsTable();
      } else {
        positionsCache = posRows;
        renderPositionsTable();
      }
    }

    async function flattenPosition(exchange, symbol) {
      if (!confirm(`确认一键平仓：${exchange} ${symbol}?\\n\\n将查询该交易所该币种持仓并 reduce-only 市价打平。\\n若存在 open/opening/closing 信号，将拒绝执行。`)) return;
      const detailsSummary = document.getElementById('detailsSummary');
      const detailsPre = document.getElementById('detailsPre');
      detailsSummary.textContent = `flatten ${exchange} ${symbol} ...`;
      detailsPre.textContent = '...';
      try {
        const resp = await postJson('/api/live_trading/flatten_position', {exchange, symbol});
        detailsSummary.textContent = JSON.stringify(resp.result || resp, null, 2);
        detailsPre.textContent = JSON.stringify(resp, null, 2);
        await refreshPositions();
        await refresh();
      } catch (e) {
        detailsSummary.textContent = String(e);
        detailsPre.textContent = String(e);
      }
    }

    async function loadDetails(signalId) {
      const detailsPre = document.getElementById('detailsPre');
      const detailsSummary = document.getElementById('detailsSummary');
      detailsPre.textContent = 'loading...';
      detailsSummary.textContent = 'loading...';
      try {
        const [orders, samples, sigResp] = await Promise.all([
          fetchJson(`/api/live_trading/orders?signal_id=${signalId}&limit=200`),
          fetchJson(`/api/live_trading/samples?signal_id=${signalId}&limit=200`),
          fetchJson(`/api/live_trading/signals?signal_id=${signalId}&limit=1&include_prices=0&include_funding=0`),
        ]);
        const sig = (sigResp && Array.isArray(sigResp.signals) && sigResp.signals.length) ? sigResp.signals[0] : null;
        const payload = sig ? sig.payload : null;
        const reval = payload?.orderbook_revalidation || null;

        function deriveCandidatesFromOrderbook(revalObj) {
          try {
            const oba = revalObj?.orderbook?.a;
            const obb = revalObj?.orderbook?.b;
            const exa = oba?.meta?.exchange || oba?.exchange || null;
            const exb = obb?.meta?.exchange || obb?.exchange || null;
            const aSell = Number(oba?.sell);
            const aBuy = Number(oba?.buy);
            const bSell = Number(obb?.sell);
            const bBuy = Number(obb?.buy);
            const out = [];
            const add = (shortEx, longEx, shortPx, longPx) => {
              const s = Number(shortPx), l = Number(longPx);
              if (!Number.isFinite(s) || !Number.isFinite(l) || l <= 0 || s <= 0) return;
              out.push({
                short_exchange: shortEx,
                long_exchange: longEx,
                short_px: s,
                long_px: l,
                tradable_spread: (s - l) / l,
                entry_spread_metric: Math.log(s / l),
                note: 'derived_from_orderbook',
              });
            };
            if (exa && exb) {
              // short on A, long on B
              add(exa, exb, aSell, bBuy);
              // short on B, long on A
              add(exb, exa, bSell, aBuy);
            }
            return out;
          } catch (e) {
            return [];
          }
        }

        const revalCandidates = (reval && Array.isArray(reval.candidates) && reval.candidates.length)
          ? reval.candidates
          : deriveCandidatesFromOrderbook(reval);

        const os = (orders.orders || []).slice().reverse(); // chronological
        const pick = (action, leg) => os.filter(o => o.action === action && o.leg === leg).slice(-1)[0];
        const openLong = pick('open', 'long');
        const openShort = pick('open', 'short');
        const closeLong = pick('close', 'long');
        const closeShort = pick('close', 'short');

        function fnum(v, nd=6) {
          if (v === null || v === undefined) return null;
          const n = Number(v);
          if (!Number.isFinite(n)) return null;
          return Number(n.toFixed(nd));
        }

        function legSummary(o) {
          if (!o) return null;
          return {
            exchange: o.exchange,
            side: o.side,
            quantity_req: o.quantity ?? null,
            filled_qty: fnum(o.filled_qty),
            avg_price: fnum(o.avg_price),
            exchange_order_id: o.exchange_order_id || null,
            status: o.status || null,
          };
        }

        let realized = null;
        try {
          const qL = Math.min(Number(openLong?.filled_qty || 0), Number(closeLong?.filled_qty || 0));
          const qS = Math.min(Number(openShort?.filled_qty || 0), Number(closeShort?.filled_qty || 0));
          const okL = qL > 0 && Number.isFinite(Number(openLong?.avg_price)) && Number.isFinite(Number(closeLong?.avg_price));
          const okS = qS > 0 && Number.isFinite(Number(openShort?.avg_price)) && Number.isFinite(Number(closeShort?.avg_price));
          if (okL && okS) {
            const pnlL = (Number(closeLong.avg_price) - Number(openLong.avg_price)) * qL;
            const pnlS = (Number(openShort.avg_price) - Number(closeShort.avg_price)) * qS;
            realized = fnum(pnlL + pnlS, 6);
          }
        } catch (e) {
          realized = null;
        }

        detailsSummary.textContent = JSON.stringify({
          signal_id: signalId,
          status: sig?.status || null,
          symbol: sig?.symbol || null,
          reason: sig?.reason || null,
          orderbook_revalidation: reval ? {...reval, candidates: revalCandidates} : null,
          orderbook_confirm_open: payload?.orderbook_confirm_open || null,
          open: { long: legSummary(openLong), short: legSummary(openShort) },
          close: { long: legSummary(closeLong), short: legSummary(closeShort) },
          realized_pnl_usdt: realized,
          note: 'filled_qty/avg_price 为 best-effort：若交易所回执不含成交信息，会尝试查询订单详情；仍可能为空。',
        }, null, 2);

        detailsPre.textContent = JSON.stringify({signal_id: signalId, signal: sig, orders: orders.orders, samples: samples.samples}, null, 2);
      } catch (e) {
        detailsPre.textContent = String(e);
        detailsSummary.textContent = String(e);
      }
    }

    async function refreshPositions() {
      const nonzero = document.getElementById('posNonzeroOnly')?.checked ? '1' : '0';
      document.getElementById('balancesBody').innerHTML = '<tr><td colspan="5" class="muted">loading...</td></tr>';
      document.getElementById('positionsBody').innerHTML = '<tr><td colspan="14" class="muted">loading...</td></tr>';
      try {
        const pos = await fetchJson(`/api/live_trading/positions?all=1&nonzero=${encodeURIComponent(nonzero)}`);
        document.getElementById('posTs').textContent = `更新时间：${pos.timestamp || '-'}`;
        renderPositionsAndBalances(pos);
      } catch (e) {
        document.getElementById('posTs').textContent = String(e);
        document.getElementById('balancesBody').innerHTML = `<tr><td colspan="5" class="muted">${String(e)}</td></tr>`;
        document.getElementById('positionsBody').innerHTML = `<tr><td colspan="14" class="muted">${String(e)}</td></tr>`;
      }
    }

    function schedule() {
      const sec = Math.max(2, Math.min(300, Number(document.getElementById('refreshSec').value || 10)));
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(() => refresh().catch(err => console.error(err)), sec * 1000);
    }

    document.getElementById('refreshBtn').addEventListener('click', () => refresh().catch(err => console.error(err)));
    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('filterSymbol').value = '';
      for (const cb of document.querySelectorAll('.status-cb')) cb.checked = false;
      updateStatusLabel();
      document.getElementById('filterType').value = '';
      document.getElementById('filterExchange').value = '';
      document.getElementById('filterPnlMin').value = '';
      document.getElementById('filterPnlMax').value = '';
      document.getElementById('filterProbMin').value = '';
      document.getElementById('filterProbMax').value = '';
      document.getElementById('filterRealMin').value = '';
      document.getElementById('filterRealMax').value = '';
      refresh().catch(err => console.error(err));
    });
    document.getElementById('posBtn').addEventListener('click', () => refreshPositions().catch(err => console.error(err)));
    document.getElementById('posBtn2').addEventListener('click', () => refreshPositions().catch(err => console.error(err)));
    document.getElementById('posNonzeroOnly').addEventListener('change', () => refreshPositions().catch(err => console.error(err)));
    document.getElementById('refreshSec').addEventListener('change', () => schedule());
    document.getElementById('signalsLimit').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterSymbol').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterType').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterExchange').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterPnlMin').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterPnlMax').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterProbMin').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterProbMax').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterRealMin').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterRealMax').addEventListener('change', () => refresh().catch(err => console.error(err)));

    function updateStatusLabel() {
      const statuses = Array.from(document.querySelectorAll('.status-cb:checked')).map(cb => cb.value);
      const el = document.getElementById('statusFilterLabel');
      if (!el) return;
      if (!statuses.length) {
        el.textContent = 'status(全部)';
        return;
      }
      if (statuses.length <= 2) {
        el.textContent = 'status: ' + statuses.join(',');
        return;
      }
      el.textContent = `status(${statuses.length})`;
    }

    function toggleStatusMenu(show) {
      const menu = document.getElementById('statusFilterMenu');
      if (!menu) return;
      const next = (show === undefined) ? (menu.style.display === 'none') : !!show;
      menu.style.display = next ? 'block' : 'none';
    }

    document.getElementById('statusFilterBtn').addEventListener('click', (e) => {
      e.preventDefault();
      toggleStatusMenu();
    });
    document.getElementById('statusSelectAllBtn').addEventListener('click', () => {
      for (const cb of document.querySelectorAll('.status-cb')) cb.checked = true;
      updateStatusLabel();
      refresh().catch(err => console.error(err));
    });
    document.getElementById('statusClearBtn').addEventListener('click', () => {
      for (const cb of document.querySelectorAll('.status-cb')) cb.checked = false;
      updateStatusLabel();
      refresh().catch(err => console.error(err));
    });
    for (const cb of document.querySelectorAll('.status-cb')) {
      cb.addEventListener('change', () => {
        updateStatusLabel();
        refresh().catch(err => console.error(err));
      });
    }
    document.addEventListener('click', (e) => {
      const wrap = document.getElementById('statusFilterWrap');
      const menu = document.getElementById('statusFilterMenu');
      if (!wrap || !menu) return;
      if (menu.style.display !== 'none' && !wrap.contains(e.target)) toggleStatusMenu(false);
    });
    updateStatusLabel();

    refresh().catch(err => console.error(err));
    schedule();
  </script>
</body>
</html>
