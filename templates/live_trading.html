<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>实盘交易（Type B）</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 16px; background: #0d1421; color: #e6edf3; }
    a { color: #58a6ff; text-decoration: none; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .card { background: #111a2a; border: 1px solid #263040; border-radius: 10px; padding: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
    .muted { color: #8b949e; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #263040; }
    .pill.ok { background: rgba(35,134,54,0.2); border-color: rgba(35,134,54,0.6); }
    .pill.warn { background: rgba(227,179,65,0.18); border-color: rgba(227,179,65,0.6); }
    .pill.bad { background: rgba(248,81,73,0.18); border-color: rgba(248,81,73,0.6); }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #263040; vertical-align: top; }
    th { text-align: left; position: sticky; top: 0; background: #111a2a; z-index: 1; }
    .table-wrap { overflow: auto; max-height: 60vh; border: 1px solid #263040; border-radius: 10px; }
    button { background: #1f6feb; border: 1px solid #2f81f7; color: #fff; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    button.secondary { background: #21262d; border-color: #30363d; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input { background: #0b1220; border: 1px solid #263040; color: #e6edf3; border-radius: 8px; padding: 6px 10px; }
    pre { margin: 0; white-space: pre-wrap; word-break: break-word; background: #0b1220; border: 1px solid #263040; border-radius: 10px; padding: 10px; max-height: 35vh; overflow: auto; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
    @media (max-width: 1100px) { .grid { grid-template-columns: 1fr; } }
    .hint { border-bottom: 1px dotted #8b949e; cursor: help; }
  </style>
</head>
<body>
  <div class="row" style="justify-content: space-between; margin-bottom: 12px;">
    <div>
      <div style="font-size: 18px; font-weight: 700;">实盘交易（Type B）</div>
      <div class="muted" style="margin-top: 4px;">订单簿 1min 监听 → 达到 0.8*pnl_hat 止盈 / 1 天强平 → 平仓下单 → 落库</div>
    </div>
    <div class="row">
      <a href="/watchlist">Watchlist</a>
      <a href="/watchlist/db">PG DB</a>
    </div>
  </div>

  <div class="card" style="margin-bottom: 12px;">
    <div class="row">
      <span id="enabledPill" class="pill">loading</span>
      <span class="muted">更新时间：</span><span id="ts" class="muted">-</span>
      <span class="muted" style="margin-left: 12px;">配置：</span><span id="cfg" class="muted">-</span>
      <span class="muted" style="margin-left: 12px;">刷新间隔(s)：</span>
      <input id="refreshSec" type="number" min="2" max="300" value="10" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">信号条数：</span>
      <input id="signalsLimit" type="number" min="10" max="2000" value="500" style="width: 90px;" />
      <span class="muted" style="margin-left: 12px;">筛选：</span>
      <input id="filterSymbol" placeholder="symbol(可选)" style="width: 120px;" />
      <input id="filterStatus" placeholder="status(可选)" style="width: 140px;" />
      <button id="refreshBtn" class="secondary">立即刷新</button>
      <button id="posBtn" class="secondary">刷新持仓(私有API)</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
        <div style="font-weight: 700;">交易信号 / 状态</div>
        <div class="muted">点击 Details 查看 orders/samples（含成交均价/数量摘要）</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width: 64px;">ID</th>
              <th style="width: 90px;">event_id</th>
              <th style="width: 90px;">Symbol</th>
              <th style="width: 90px;">Type</th>
              <th style="width: 200px;">Exchanges</th>
              <th style="width: 120px;">
                <span class="hint" title="交易所A（Long腿）开仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">A Long 开仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所A（Long腿）平仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">A Long 平仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所B（Short腿）开仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">B Short 开仓价</span>
              </th>
              <th style="width: 120px;">
                <span class="hint" title="交易所B（Short腿）平仓成交均价：来自订单回执/订单查询的 best-effort avg_price（可能为空）。">B Short 平仓价</span>
              </th>
              <th style="width: 130px;">
                <span class="hint" title="实际盈亏（USDT，未计资金费/手续费）：按两条腿的开/平仓成交均价和成交数量估算。Long腿：(close-open)*qty；Short腿：(open-close)*qty；qty 取开/平两侧 filled_qty 的最小值。">realized_pnl</span>
              </th>
              <th style="width: 90px;">Status</th>
              <th style="width: 110px;">
                <span class="hint" title="pnl_hat_ob：下单前用两家交易所订单簿“扫单成交价”（按每腿名义金额）重新计算关键因子，并在 horizon=240min 上回归预测得到的预计收益（小数，如 0.012=1.2%）。">pnl_hat_ob</span>
              </th>
              <th style="width: 110px;">
                <span class="hint" title="tp_pnl：止盈阈值（小数），默认 tp_pnl = take_profit_ratio * pnl_hat_ob（当前 take_profit_ratio=0.8）。当 last_pnl >= tp_pnl 时会进入“止盈候选”，系统会在几秒内再做两次订单簿复核（共3次）确认价差仍满足，才真正发起平仓；否则本次止盈作废，等待下一次监控判定。">tp_pnl</span>
              </th>
              <th style="width: 110px;">
                <span class="hint" title="last_pnl：最近一次 1min 监控样本计算的“订单簿估算PnL指标”（小数，口径为价差变化而非账户真实收益）。计算：last_pnl = entry_spread_metric - now_spread_metric，其中 entry_spread_metric=log(short_sell_entry/long_buy_entry)，now_spread_metric=log(short_buy_now/long_sell_now)。注意：不包含手续费/资金费/滑点/成交延迟，且若订单簿/合约口径与实际下单不一致，可能与 realized_pnl_usdt 显著偏离。">last_pnl</span>
              </th>
              <th style="width: 170px;">created_at</th>
              <th style="width: 170px;">opened_at</th>
              <th style="width: 170px;">close_req_at</th>
              <th style="width: 170px;">closed_at</th>
              <th style="width: 170px;">force_close_at</th>
              <th style="width: 140px;">close_reason</th>
              <th style="width: 200px;">reason</th>
              <th style="width: 90px;">Details</th>
            </tr>
          </thead>
          <tbody id="signalsBody">
            <tr><td colspan="22" class="muted">loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div style="font-weight: 700; margin-bottom: 8px;">最近错误</div>
      <pre id="errorsPre" class="muted">loading...</pre>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
      <div style="font-weight: 700;">Details</div>
      <div class="muted">orders / samples / positions（按需加载）</div>
    </div>
    <pre id="detailsSummary" class="muted" style="margin-bottom: 8px;">点击某个 signal 的 Details 按钮</pre>
    <pre id="detailsPre" class="muted">-</pre>
  </div>

  <script>
    let refreshTimer = null;

    function fmt(v, nd=6) {
      if (v === null || v === undefined) return '-';
      const n = Number(v);
      if (!Number.isFinite(n)) return String(v);
      return n.toFixed(nd);
    }

    function pillForStatus(status) {
      const s = (status || '').toLowerCase();
      if (s === 'open') return ['open', 'ok'];
      if (s === 'opening' || s === 'closing') return [s, 'warn'];
      if (s === 'closed') return ['closed', 'ok'];
      if (s === 'failed') return ['failed', 'bad'];
      return [status || '-', ''];
    }

    async function fetchJson(url) {
      const resp = await fetch(url, {cache: 'no-store'});
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || resp.statusText);
      return data;
    }

    async function postJson(url, body) {
      const resp = await fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body || {}),
        cache: 'no-store',
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || resp.statusText);
      return data;
    }

    async function refresh() {
      const overview = await fetchJson('/api/live_trading/overview?limit=80');
      const limit = Math.max(10, Math.min(2000, Number(document.getElementById('signalsLimit').value || 500)));
      const symbol = (document.getElementById('filterSymbol').value || '').trim();
      const status = (document.getElementById('filterStatus').value || '').trim();
      const qs = new URLSearchParams({limit: String(limit)});
      if (symbol) qs.set('symbol', symbol);
      if (status) qs.set('status', status);
      const signalsResp = await fetchJson(`/api/live_trading/signals?${qs.toString()}`);
      document.getElementById('ts').textContent = overview.timestamp || '-';
      const cfg = overview.live_trading_config || {};
      document.getElementById('cfg').textContent = `per_leg=${cfg.per_leg_notional_usdt || '-'} horizon=${cfg.horizon_min || '-'} pnl>=${cfg.pnl_threshold || '-'} prob>=${cfg.win_prob_threshold || '-'} lookback=${cfg.event_lookback_minutes || '-'}m ex=${cfg.allowed_exchanges || '-'}`;

      const enabled = !!overview.live_trading_enabled;
      const pill = document.getElementById('enabledPill');
      pill.textContent = enabled ? 'LIVE_TRADING_ENABLED=1' : 'LIVE_TRADING_ENABLED=0';
      pill.className = 'pill ' + (enabled ? 'ok' : 'warn');

      const errors = (overview.errors || []).slice(0, 30);
      document.getElementById('errorsPre').textContent = JSON.stringify(errors, null, 2);

      const body = document.getElementById('signalsBody');
      const signals = signalsResp.signals || [];
      if (!signals.length) {
        body.innerHTML = '<tr><td colspan="22" class="muted">暂无数据</td></tr>';
        return;
      }

      body.innerHTML = signals.map(s => {
        const [stText, stCls] = pillForStatus(s.status);
        const ex = `${s.leg_long_exchange || '-'}(long) / ${s.leg_short_exchange || '-'}(short)`;
        const aOpen = fmt(s.open_long_avg_price, 8);
        const aClose = fmt(s.close_long_avg_price, 8);
        const bOpen = fmt(s.open_short_avg_price, 8);
        const bClose = fmt(s.close_short_avg_price, 8);
        const realized = fmt(s.realized_pnl_usdt, 6);
        const stKey = String(s.status || '').toLowerCase();
        const canForceClose = stKey !== 'closed';
        const createdAt = s.created_at || '-';
        const openAt = s.opened_at || '-';
        const closeReqAt = s.close_requested_at || '-';
        const closedAt = s.closed_at || '-';
        const forceAt = s.force_close_at || '-';
        const closeReason = s.close_reason || '-';
        const reason = s.reason || '-';
        return `
          <tr>
            <td>${s.id}</td>
            <td class="muted">${s.event_id || '-'}</td>
            <td>${s.symbol || '-'}</td>
            <td class="muted">${s.signal_type || '-'}</td>
            <td class="muted">${ex}</td>
            <td class="muted">${aOpen}</td>
            <td class="muted">${aClose}</td>
            <td class="muted">${bOpen}</td>
            <td class="muted">${bClose}</td>
            <td class="muted">${realized}</td>
            <td><span class="pill ${stCls}">${stText}</span></td>
            <td>${fmt(s.pnl_hat_ob, 6)}</td>
            <td>${fmt(s.take_profit_pnl, 6)}</td>
            <td>${fmt(s.last_pnl_spread, 6)}</td>
            <td class="muted">${createdAt}</td>
            <td class="muted">${openAt}</td>
            <td class="muted">${closeReqAt}</td>
            <td class="muted">${closedAt}</td>
            <td class="muted">${forceAt}</td>
            <td class="muted">${closeReason}</td>
            <td class="muted">${reason}</td>
            <td>
              <button class="secondary" onclick="loadDetails(${s.id})">Details</button>
              <button class="secondary" ${canForceClose ? '' : 'disabled'} onclick="forceClose(${s.id})">一键平仓</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function forceClose(signalId) {
      if (!confirm(`确认一键平仓 signal_id=${signalId} ?\\n\\n将同时查询两交易所持仓并以 reduce-only 市价打平。`)) return;
      const detailsPre = document.getElementById('detailsPre');
      const detailsSummary = document.getElementById('detailsSummary');
      detailsSummary.textContent = `force closing signal_id=${signalId} ...`;
      detailsPre.textContent = '...';
      try {
        const resp = await postJson('/api/live_trading/force_close', {signal_id: signalId});
        detailsSummary.textContent = JSON.stringify(resp.result || resp, null, 2);
        detailsPre.textContent = JSON.stringify(resp, null, 2);
        await refresh();
      } catch (e) {
        detailsSummary.textContent = String(e);
        detailsPre.textContent = String(e);
      }
    }

    async function loadDetails(signalId) {
      const detailsPre = document.getElementById('detailsPre');
      const detailsSummary = document.getElementById('detailsSummary');
      detailsPre.textContent = 'loading...';
      detailsSummary.textContent = 'loading...';
      try {
        const [orders, samples] = await Promise.all([
          fetchJson(`/api/live_trading/orders?signal_id=${signalId}&limit=200`),
          fetchJson(`/api/live_trading/samples?signal_id=${signalId}&limit=200`),
        ]);

        const os = (orders.orders || []).slice().reverse(); // chronological
        const pick = (action, leg) => os.filter(o => o.action === action && o.leg === leg).slice(-1)[0];
        const openLong = pick('open', 'long');
        const openShort = pick('open', 'short');
        const closeLong = pick('close', 'long');
        const closeShort = pick('close', 'short');

        function fnum(v, nd=6) {
          if (v === null || v === undefined) return null;
          const n = Number(v);
          if (!Number.isFinite(n)) return null;
          return Number(n.toFixed(nd));
        }

        function legSummary(o) {
          if (!o) return null;
          return {
            exchange: o.exchange,
            side: o.side,
            quantity_req: o.quantity ?? null,
            filled_qty: fnum(o.filled_qty),
            avg_price: fnum(o.avg_price),
            exchange_order_id: o.exchange_order_id || null,
            status: o.status || null,
          };
        }

        let realized = null;
        try {
          const qL = Math.min(Number(openLong?.filled_qty || 0), Number(closeLong?.filled_qty || 0));
          const qS = Math.min(Number(openShort?.filled_qty || 0), Number(closeShort?.filled_qty || 0));
          const okL = qL > 0 && Number.isFinite(Number(openLong?.avg_price)) && Number.isFinite(Number(closeLong?.avg_price));
          const okS = qS > 0 && Number.isFinite(Number(openShort?.avg_price)) && Number.isFinite(Number(closeShort?.avg_price));
          if (okL && okS) {
            const pnlL = (Number(closeLong.avg_price) - Number(openLong.avg_price)) * qL;
            const pnlS = (Number(openShort.avg_price) - Number(closeShort.avg_price)) * qS;
            realized = fnum(pnlL + pnlS, 6);
          }
        } catch (e) {
          realized = null;
        }

        detailsSummary.textContent = JSON.stringify({
          signal_id: signalId,
          open: { long: legSummary(openLong), short: legSummary(openShort) },
          close: { long: legSummary(closeLong), short: legSummary(closeShort) },
          realized_pnl_usdt: realized,
          note: 'filled_qty/avg_price 为 best-effort：若交易所回执不含成交信息，会尝试查询订单详情；仍可能为空。',
        }, null, 2);

        detailsPre.textContent = JSON.stringify({signal_id: signalId, orders: orders.orders, samples: samples.samples}, null, 2);
      } catch (e) {
        detailsPre.textContent = String(e);
        detailsSummary.textContent = String(e);
      }
    }

    async function refreshPositions() {
      const detailsPre = document.getElementById('detailsPre');
      detailsPre.textContent = 'loading positions...';
      try {
        const pos = await fetchJson('/api/live_trading/positions?limit=30');
        detailsPre.textContent = JSON.stringify(pos, null, 2);
      } catch (e) {
        detailsPre.textContent = String(e);
      }
    }

    function schedule() {
      const sec = Math.max(2, Math.min(300, Number(document.getElementById('refreshSec').value || 10)));
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(() => refresh().catch(err => console.error(err)), sec * 1000);
    }

    document.getElementById('refreshBtn').addEventListener('click', () => refresh().catch(err => console.error(err)));
    document.getElementById('posBtn').addEventListener('click', () => refreshPositions().catch(err => console.error(err)));
    document.getElementById('refreshSec').addEventListener('change', () => schedule());
    document.getElementById('signalsLimit').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterSymbol').addEventListener('change', () => refresh().catch(err => console.error(err)));
    document.getElementById('filterStatus').addEventListener('change', () => refresh().catch(err => console.error(err)));

    refresh().catch(err => console.error(err));
    schedule();
  </script>
</body>
</html>
